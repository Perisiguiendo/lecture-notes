# DNS

## DNS 基本概述

与 HTTP、FTP 和 SMTP 一样，DNS 协议也是应用层的协议。

DNS 使用 `客户-服务器` 模式运行在通信的端系统之间，在通信的端系统之间通过下面的端到端运输协议来传送 DNS 报文。但是 DNS 不是一个直接和用户打交道的应用。DNS 是为因特网上的用户应用程序以及其他软件提供一种核心功能。

DNS 通常不是一门独立的协议，它通常为其他应用层协议所使用，这些协议包括 HTTP、SMTP 和 FTP，将用户提供的主机名解析为 IP 地址。

下面根据一个示例来描述一下这个 DNS 解析过程，这个和你输入网址后，浏览器做了什么操作有异曲同工之处

你在浏览器键入 [www.someschool.edu/index.html](http://www.someschool.edu/index.html) 时会发生什么现象？为了使用户主机能够将一个 HTTP 请求报文发送到 Web 服务器 [www.someschool.edu](http://www.someschool.edu/) ，会经历如下操作

- 同一台用户主机上运行着 DNS 应用的客户端
- 浏览器从上述 URL 中抽取出主机名 [www.someschool.edu](http://www.someschool.edu/) ，并将这台主机名传给 DNS 应用的客户端
- DNS 客户向 DNS 服务器发送一个包含主机名的请求。
- DNS 客户最终会收到一份回答报文，其中包含该目标主机的 IP 地址
- 一旦浏览器收到目标主机的 IP 地址后，它就能够向位于该 IP 地址 80 端口的 HTTP 服务器进程发起一个 TCP 连接。

除了提供 IP 地址到主机名的转换，DNS 还提供了下面几种重要的服务

- `主机别名(host aliasing)`，有着复杂的主机名的主机能够拥有一个或多个其他别名，比如说一台名为 relay1.west-coast.enterprise.com 的主机，同时会拥有 enterprise.com 和 [www.enterprise.com](http://www.enterprise.com/) 的两个主机别名，在这种情况下，relay1.west-coast.enterprise.com 也称为 `规范主机名`，而主机别名要比规范主机名更加容易记忆。应用程序可以调用 DNS 来获得主机别名对应的规范主机名以及主机的 IP地址。
- `邮件服务器别名(mail server aliasing)`，同样的，电子邮件的应用程序也可以调用 DNS 对提供的主机名进行解析。
- `负载分配(load distribution)`，DNS 也用于冗余的服务器之间进行负载分配。繁忙的站点例如 `cnn.com` 被冗余分布在多台服务器上，每台服务器运行在不同的端系统之间，每个都有着不同的 IP 地址。由于这些冗余的 Web 服务器，一个 IP 地址集合因此与同一个规范主机名联系。DNS 数据库中存储着这些 IP 地址的集合。由于客户端每次都会发起 HTTP 请求，所以 DNS 就会在所有这些冗余的 Web 服务器之间循环分配了负载。

## DNS如何工作的

- DNS 协议提供的是一种主机名到 IP 地址的转换服务，就是我们常说的域名系统。
- 是应用层协议，通常该协议运行在UDP协议之上，使用的是53端口号。

**「我们通过一张图来看看它的查询过程吧」**👇

![img](https://user-images.githubusercontent.com/34484322/89356512-95168e80-d6f0-11ea-93aa-c4f59fd36942.png)

这张图很生动的展示了DNS在本地DNS服务器是如何查询的，**「一般向本地DNS服务器发送请求是递归查询的」**

本地 DNS 服务器向其他域名服务器请求的过程是迭代查询的过程👇

<img src="https://user-images.githubusercontent.com/34484322/89356522-99db4280-d6f0-11ea-9bf9-851b25bd16c3.png" alt="DNS查询" style="zoom:67%;" />



## 递归查询和迭代查询

- 递归查询指的是查询请求发出后，域名服务器代为向下一级域名服务器发出请求，最后向用户返回查询的最终结果。使用递归 查询，用户只需要发出一次查询请求。
- 迭代查询指的是查询请求后，域名服务器返回单次查询的结果。下一级的查询由用户自己请求。使用迭代查询，用户需要发出 多次的查询请求。

所以一般而言，**「本地服务器查询是递归查询」**，而**「本地 DNS 服务器向其他域名服务器请求的过程是迭代查询的过程」**。

### DNS缓存

缓存也很好理解，在一个请求中，当某个DNS服务器收到一个DNS回答后，它能够回答中的信息缓存在本地存储器中。**「返回的资源记录中的 TTL 代表了该条记录的缓存的时间。」**

### DNS实现负载平衡

它是如何实现负载均衡的呢？首先我们得清楚DNS 是可以用于在冗余的服务器上实现负载平衡。

**原因：**这是因为一般的大型网站使用多台服务器提供服务，因此一个域名可能会对应 多个服务器地址。

举个例子来说👇

- 当用户发起网站域名的 DNS 请求的时候，DNS 服务器返回这个域名所对应的服务器 IP 地址的集合
- 在每个回答中，会循环这些 IP 地址的顺序，用户一般会选择排在前面的地址发送请求。
- 以此将用户的请求均衡的分配到各个不同的服务器上，这样来实现负载均衡。

### 总结

- DNS域名系统，是应用层协议，运行UDP协议之上，使用端口43。
- 查询过程，本地查询是递归查询，依次通过浏览器缓存 `—>>` 本地hosts文件 `—>>` 本地DNS解析器 `—>>`本地DNS服务器 `—>>` 其他域名服务器请求。 接下来的过程就是迭代过程。
- 递归查询一般而言，发送一次请求就够，迭代过程需要用户发送多次请求。

## DNS 为什么使用 UDP 协议作为传输层协议？

**「DNS 使用 UDP 协议作为传输层协议的主要原因是为了避免使用 TCP 协议时造成的连接时延。」**

- 为了得到一个域名的 IP 地址，往往会向多个域名服务器查询，如果使用 TCP 协议，那么每次请求都会存在连接时延，这样使 DNS 服务变得很慢。
- 大多数的地址查询请求，都是浏览器请求页面时发出的，这样会造成网页的等待时间过长。

## DNS解析流程

DNS是把域名解析成IP地址的过程，是非常重要的一个知识点，当输入URL时，第一步就是通过DNS将URL转换成IP，浏览器的过程如下：

**1，** 首先，浏览器会从自身的DNS缓存中去查找（chrome://net-internals/#dns），如果没有则进行下一步

**2，** 然后，浏览器会先从操作系统里的DNS缓存中找，windows系统中，命令行 ipconfig/displaydns 查看，linux上的NSCD缓存服务；；；如果没有则进行下一步

**3，** 从计算机host文件里找，这个我们经常配置吧；；；如果没有则进行下一步

**4，** 请求本地域名服务器（可以认为是你的网络接入服务器商提供，比如中国电信，中国移动，阿里云等域名供应商），如果该服务器有缓存，则直接返回，若没有，则下一步。。。一般80%到这里就可以了（比如你申请一个域名，去阿里云，那么你肯定会写上域名所指向的IP啊）。

**5，** 若上一步都没命中，那么就需要向根域名服务器迭代请求了，见下面：

**准备：**

- 首先需要知道的是，根域名服务器和顶级域名服务器全世界大概有十几台，是最顶尖的了，大概知道就行。
- 其次，实际上我们的网址应该为  test.baidu.com **.**  ，注意看后面有的 **点** ，只不过浏览器为了方便用户都给省略了。

比如解析test.baidu.com.   ，是具体怎么解析成IP地址的呢？可以形容为，**从右向左**

. -> .com -> baidu.com. -> test.baidu.com

（1）请求根域名服务器，带着 test.baidu.com.   ，根域名服务器发现是  .com 结尾，然后告诉你，我只知道 com顶级域名服务器 的IP地址，你去问问它试试

（2）然后浏览器就向 com顶级域名服务器 请求，带着 test.baidu.com.   ，com顶级域名服务器 只知道 baidu.com. 所在的服务器地址，并不知道 test. 是啥（因为test.这二级域名，只有百度自己知道啊，因为是百度自己设定的，就像crm.credit.cn，是不是只有公司才知道crm是个啥？）。。。所以 com顶级域名服务器 会告诉你，我只知道baidu.com. 所在的IP地址，你去问问它把（百度公司的web服务器）

（3）然后就向 "百度公司域名服务器" 请求，带着 test.baidu.com. ，百度公司自己肯定知道 test 是个啥，所以百度公司，就把最后真正的IP地址，返回给浏览器，到此，迭代查询完成了

**思考：为什么需要迭代查询呢？**

如果没有分层，那全世界所有的域名都交由根服务器管理？那不是很乱吗？

所以对域名进行分层次的架构，方便管理



![img](https://user-gold-cdn.xitu.io/2020/7/20/1736bd957661d78a?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)



可以想象出了，crm.credit.com 是让公司运维做的指向吧

然后credit.com ，也就是默认www.credit.com，是公司在com域名服务器上面申请的域名吧

com域名服务器肯定是注册到了根域名服务器上了



![img](https://user-gold-cdn.xitu.io/2020/7/20/1736bd9ccc7e7f09?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)





![img](https://user-gold-cdn.xitu.io/2020/7/20/1736bd9ec75d539d?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)



## 前端DNS优化

### 1，减少DNS查询次数

DNS查询需要时间，但是因为DNS可以在浏览器和计算机中缓存一段时间，所以一般只是首次加载网页时会对域名进行解析。

所以尽量减少链子不同 domain 的请求的数量，比如将外部的资源提前下载到同域名的服务器上等。

### 2，DNS预解析

预解析的原理就是，当加载一个html时，会自动解析其中 a 标签所包含的 href 链接为IP地址，并缓存，如

```
// index.html
<html>
    <a href="test.baidu.com"></a>
</html>
复制代码
```

当加载index.html时，会预先解析test.baidu.com，之后如果真的点击访问了test.baidu.com，就不需要DNS解析了。

注意，在HTTPS页面中，不会自动预解析，所以需要手动添加

```
<link rel="dns-prefetch" href="//img.alicdn.com">
复制代码
```

上面是添加单条的解析，也可以开启自动对所有链接的解析

```
<meta http-equiv="x-dns-prefetch-control" content="on">
复制代码
```

**注意：并非所有页面都要手动解析，一般在整个站点的入口页做这个工作就行了，毕竟一个站点下用到的大多数域名都会在首页体现**

DNS Prefetch 是对网页性能优化的一个通用方案，对国际化的站点来说可能效果更加明显。学习成本和理解成本低，可以放心大胆地用到自己的网页上


作者：晴天633
链接：https://juejin.cn/post/6854573212425814030
来源：掘金
著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。

# DNS基础知识

# DNS 是什么

DNS (Domain Name System)， 也叫网域名称系统，是互联网的一项服务。它实质上是一个 **域名** 和 **IP** 相互映射的分布式数据库，有了它，我们就可以通过域名更方便的访问互联网。

DNS有以下特点:

- 分布式的
- 协议支持TCP 和 UDP, 常用端口是53
- 每一级域名的长度限制是63
- 域名总长度限制是253

**那么，什么情况下使用TCP，什么情况下使用UDP呢?**

最早的时候，DNS 的UDP报文上限大小是512 字节， 所以当某个response大小超过512 (返回信息太多)，DNS服务就会使用TCP协议来传输。后来DNS 协议扩展了自己的UDP协议，DNS client 发出查询请求时，可以指定自己能接收超过512字节的UDP包， 这种情况下，DNS 还是会使用UDP协议

## 分层的数据库结构

DNS 的结构跟Linux 文件系统很相似，像一棵倒立的树。 下面用站长之家的域名举例:



![img](https://user-gold-cdn.xitu.io/2017/9/23/3a7b7303790037d1379d2ac829127aa0?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)



最上面的.是根域名, 接着是顶级域名com，再下来是站长之家域名chinaz 依次类推。 使用域名时，从下而上。 s.tool.chinaz.com. 就是一个完整的域名, www.chinaz.com. 也是。

**之所以设计这样复杂的树形结构， 是为了防止名称冲突。** 这样一棵树结构，当然可以存储在一台机器上，但现实世界中完整的域名非常多，并且每天都在新增、删除大量的域名，存在一台机器上，对单机器的存储性能就是不小的挑战。 另外，集中管理还有一个缺点就是管理不够灵活。 可以想象一下，每次新增、删除域名都需要向中央数据库申请是多么麻烦。 所以**现实中的DNS 都是分布式存储的。**

根域名服务器只管理顶级域，同时把每个顶级域的管理委派给各个顶级域，所以当你想要申请com下的二级域名时，找com域名注册中心就好了。 例如你申请了上图的chinaz.com二级域名， chinaz.com 再向下的域名就归你管理了。 当你管理chinaz.com的子域名时，你可以搭建自己的nameserver, 在.com注册中心把chinaz.com的管理权委派给自己搭建的nameserver。 自建nameserver 和不自建的结构图如下:



![img](https://user-gold-cdn.xitu.io/2017/9/23/8bfc45c49feb40ec01409f53de41788b?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)



一般情况下，能不自建就不要自建，因为维护一个高可用的DNS也并非容易。据我所知，有两种情况需要搭建自己的nameserver:

1. **搭建对内的DNS。**公司内部机器众多，通过ip相互访问太过凌乱，这时可以搭建对内的nameserver，允许内部服务器通过域名互通
2. **公司对域名厂商提供的nameserver性能不满意。**虽然顶级域名注册商都有自己的nameserver, 但注册商提供的nameserver 并不专业，在性能和稳定性上无法满足企业需求，这时就需要企业搭建自己的高性能nameserver，比如增加智能解析功能，让不同地域的用户访问最近的IP，以此来提高服务质量

概括一下DNS的分布式管理， 当把一个域委派给一个nameserver后，这个域下的管理权都交由此nameserver处理。 这种设计一方面解决了存储压力，另一方面提高了域名管理的灵活性 (这种结构像极了Linux File System, 可以把任何一个子目录挂载到另一个磁盘，还可以把它下面的子目录继续挂载出去)

## 顶级域名

像com这样的顶级域名，由ICANN 严格控制，是不允许随便创建的。顶级域名分两类:

- 通用顶级域名
- 国家顶级域名

通用顶级域名常见的如.com、 .org、.edu等， 国家顶级域名如我国的.cn， 美国的.us。 一般公司申请公网域名时，如果是跨国产品，应该选择通用顶级域名；如果没有跨国业务，看自己喜好（可以对比各家顶级域的服务、稳定性等再做选择）。 这里说一下几个比较热的顶级域，完整的顶级域参见[维基百科](https://zh.wikipedia.org/wiki/互联网顶级域列表)。

**me**
me顶级域其实是国家域名， 是`黑山共和国`的国家域名，只不过它对个人开发申请，所以很多个人博主就用它作为自己的博客域名（本博客也是这么来的~)

**io**
很多开源项目常用io做顶级域名，它也是国家域名。 因为io 与计算机中的 input/output 缩写相同，和计算机的二机制10也很像，给人一种geek的感觉。相较于.com域名，.io下的资源很多，更多选择.

# DNS 解析流程

聊完了DNS 的基本概念，我们再来聊一聊DNS 的解析流程。 当我们通过浏览器或者应用程序访问互联网时，都会先执行一遍DNS解析流程。标准glibc提供了libresolv.so.2 动态库，我们的应用程序就是用它进行域名解析(也叫resolving)的， 它还提供了一个配置文件`/etc/nsswitch.conf`来控制resolving行为，配置文件中最关键的是这行:

```
hosts:      files dns myhostname复制代码
```

它决定了resolving 的顺序，默认是先查找hosts文件，如果没有匹配到，再进行DNS解析。默认的解析流程如下图:



![img](https://user-gold-cdn.xitu.io/2017/9/23/5916fc89a789d7fc3ff24b981e7fe91d?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)



上图主要描述了client端的解析流程，我们可以看到最主要的是第四步请求本地DNS服务器去执行resolving，它会根据本地DNS服务器配置，发送解析请求到递归解析服务器（稍后介绍什么是递归解析服务器)， 本地DNS服务器在 `/etc/resolv.conf` 中配置。 下面我们再来看看服务端的resolving流程:



![img](https://user-gold-cdn.xitu.io/2017/9/23/d30ca05abf14b4f94dfef920e91af412?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)



我们分析一下解析流程:

1. 客户端向本地DNS服务器(递归解析服务器) 发出解析tool.chinaz.com域名的请求
2. 本地dns服务器查看缓存，是否有缓存过tool.chinaz.com域名，如果有直接返回给客户端；如果没有执行下一步
3. 本地dns服务器向根域名服务器发送请求，查询com顶级域的nameserver 地址
4. 拿到com域名的IP后，再向com nameserver发送请求，获取chinaz域名的nameserver地址
5. 继续请求chinaz的nameserver, 获取tool域名的地址，最终得到了tool.chinaz.com的IP，本地dns服务器把这个结果缓存起来，以供下次查询快速返回
6. 本地dns服务器把把结果返回给客户端

**递归解析服务器 vs 权威域名服务器**

我们在解析流程中发现两类DNS服务器，客户端直接访问的是 `递归解析服务器`， 它在整个解析过程中也最忙。 它的查询步骤是递归的，从根域名服务器开始，一直询问到目标域名。

递归解析服务器通过请求一级一级的权威域名服务器，获得下一目标的地址，直到找到目标域名的 `权威域名服务器`

简单来说： `递归解析服务器` 是负责解析域名的， `权威域名服务器`是负责存储域名记录的

递归解析服务器一般由ISP提供，除此之外也有一些比较出名的公共递归解析服务器， 如谷歌的8.8.8.8，联通的114，BAT也都有推出公共递归解析服务器，但性能最好的应该还是你的ISP提供的，只是可能会有 `DNS劫持` 的问题

**缓存**

由于整个解析过程非常复杂，所以DNS 通过缓存技术来实现服务的鲁棒性。 当递归nameserver解析过tool.chianaz.com 域名后，再次收到tool.chinaz.com查询时，它不会再走一遍递归解析流程，而是把上一次解析结果的缓存直接返回。 并且它是分级缓存的，也就是说，当下次收到的是www.chinaz.com的查询时， 由于这台递归解析服务器已经知道chinaz.com的权威nameserver, 所以它只需要再向chinaz.com nameserver 发送一个查询www的请求就可以了。

**根域名服务器**
递归解析服务器是怎么知道 `根域名服务器`的地址的呢？ 根域名服务器的地址是固定的，目前全球有13个根域名解析服务器，这13条记录持久化在递归解析服务器中:



![img](https://user-gold-cdn.xitu.io/2017/9/23/772e5d20f133fb9c9ae3c4cada0e16bb?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)



为什么只有13个根域名服务器呢，不是应该越多越好来做负载均衡吗？ 之前说过DNS 协议使用了UDP查询， 由于UDP查询中能保证性能的最大长度是512字节，要让所有根域名服务器数据能包含在512字节的UDP包中， 根服务器只能限制在13个， 而且每个服务器要使用字母表中单字母名

**智能解析**

智能解析，就是当一个域名对应多个IP时，当你查询这个域名的IP，会返回离你最近的IP。 由于国内不同运营商之间的带宽很低，所以电信用户访问联通的IP就是一个灾难，而智能DNS解析就能解决这个问题。

智能解析依赖EDNS协议，这是google 起草的DNS扩展协议， 修改比较简单，就是在DNS包里面添加origin client IP, 这样nameserver 就能根据client IP 返回距离client 比较近的server IP 了

国内最新支持EDNS的就是DNSPod 了，DNSPod 是国内比较流行的域名解析厂商，很多公司会把域名利用DNSPod 加速， 它已经被鹅厂收购

# 域名注册商

一般我们要注册域名，都要需要找域名注册商，比如说我想注册hello.com，那么我需要找com域名注册商注册hello域名。com的域名注册商不止一家， 这些域名注册商也是从ICANN 拿到的注册权， 参见[如何申请成为.com域名注册商](https://www.zhihu.com/question/19578540)

那么，`域名注册商` 和 `权威域名解析服务器` 有什么关系呢？ 域名注册商都会自建权威域名解析服务器，比如你在狗爹上申请一个.com下的二级域名，你并不需要搭建nameserver， 直接在godaddy控制中心里管理你的域名指向就可以了， 原因就是你新域名的权威域名服务器默认由域名注册商提供。 当然你也可以更换，比如从godaddy申请的境外域名，把权威域名服务器改成DNSPod，一方面加快国内解析速度，另一方面还能享受DNSPod 提供的智能解析功能

# 用bind搭建域名解析服务器

由于网上介绍bind搭建的文章实在太多了，我就不再赘述了， 喜欢动手的朋友可以网上搜一搜搭建教程，一步步搭建一个本地的nameserver 玩一玩。这里主要介绍一下bind 的配置文件吧

bind 的配置文件分两部分: `bind配置文件` 和 `zone配置文件`

## bind配置文件

bind配置文件位于`/etc/named.conf`，它主要负责bind功能配置，如zone路径、日志、安全、主从等配置



![img](https://user-gold-cdn.xitu.io/2017/9/23/ecba67163d2e153e943d6b45a5d53792?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)



其中最主要的是添加zone的配置以及指定zone配置文件。 `recursion` 开启递归解析功能， 这个如果是no， 那么此bind服务只能做权威解析服务，当你的bind服务对外时，打开它会有安全风险，如何防御不当，会让你的nameserver 被hacker 用来做肉鸡

## zone配置文件

zone的配置文件在bind配置文件中指定，下图是一份简单的zone配置:



![img](https://user-gold-cdn.xitu.io/2017/9/23/8469d461fb37f4fadf503cf8d5d760a6?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)



zone的配置是nameserver的核心配置， 它指定了DNS 资源记录，如SOA、A、CNAME、AAAA等记录，各种记录的概念网上资料太多，我这里就不重复了。其中主要讲一下SOA 和 CNAME 的作用。

**SOA记录**

SOA 记录表示此域名的权威解析服务器地址。 上文讲了权威解析服务器和递归解析服务器的差别， 当所有递归解析服务器中有没你域名解析的缓存时，它们就会回源来请求此域名的SOA记录，也叫权威解析记录

**CNAME**

CNAME 的概念很像别名，它的处理逻辑也如此。 一个server 执行resloving 时，发现name 是一个CNAME， 它会转而查询这个CNAME的A记录。一般来说，能使用CNAME的地方都可以用A记录代替， 那么为什么还要发明CNAME这样一个东西呢？ 它是让多个域名指向同一个IP的一种快捷手段， 这样当最低层的CNAME 对应的IP换了之后，上层的CNAME 不用做任何改动。就像我们代码中的硬编码，我们总会去掉这些硬编码，用一个变量来表示，这样当这个变量变化时，我们只需要修改一处

配置完之后可以用`named-checkconf` 和 `named-checkzone` 两个命令来check我们的配置文件有没有问题， 之后就可以启动bind服务了:

```
$> service named start
Redirecting to /bin/systemctl restart  named.service复制代码
```

我们用`netstat -ntlp` 来检查一下服务是否启动:



![img](https://user-gold-cdn.xitu.io/2017/9/23/cedc58a110b25a1849cbc03cf14742eb?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)



53端口已启动，那么我们测试一下效果， 用dig解析一下`www.hello.com`域名， 使用127.0.0.1 作为递归解析服务器



![img](https://user-gold-cdn.xitu.io/2017/9/23/02c09c201be13d66b370566ffe05381c?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)



我们看到dig的结果跟我们配置文件中配置的一样是1.2.3.4，DNS完成了它的使命，根据域名获取到IP，但我们这里用来做示范的IP明显是个假IP:)

## 用DNS 实现负载均衡

一个域名添加多条A记录，解析时使用轮询的方式返回随机一条，流量将会均匀分类到多个A记录。

```
www     IN      A       1.2.3.4
www     IN      A       1.2.3.5复制代码
```

上面的配置中，我们给www域添加了两条A记录， 这种做法叫`multi-homed hosts`， 它的效果是：当我们请求nameserver 解析www.hello.com 域名时，返回的IP会在两个IP中轮转(默认行为，有些智能解析DNS会根据IP判断，返回一个离client近的IP, 距离 请搜索`DNS智能解析`)。

其实每次DNS解析请求时，nameserver都会返回全部IP，如上面配置，它会把1.2.3.4 和1.2.3.5 都返回给client端。 那么它是怎么实现RR的呢？ nameserver 只是每次返回的IP排序不同，客户端会把response里的第一个IP用来发请求。

**DNS负载均衡 vs LVS专业负载均衡**

和 LVS 这种专业负载均衡工具相比，在DNS层做负载均衡有以下特点:

1. 实现非常简单
2. 默认只能通过RR方式调度
3. DNS 对后端服务不具备健康检查
4. DNS 故障恢复时间比较长（DNS服务之间有缓存）
5. 可负载的rs数量有限（受DNS response包大小限制)

真实场景中，还需要根据需求选择相应的负载均衡策略

## 子域授权

我们从.com域下申请一个二级域名hello.com后， 发展到某一天我们的公司扩大了，需要拆分两个事业部A和B， 并且公司给他们都分配了三级域名 `a.hello.com` 和 `b.hello.com`， 域名结构如下图:



![img](https://user-gold-cdn.xitu.io/2017/9/23/fd5a0a0fc010ecf504fe5d8c98358ef4?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)



再发展一段时间， A部门和B部门内部业务太多，需要频繁的为新产品申请域名， 这个时候他们就想搭建自己的namserver, 并且需要上一级把相应的域名管理权交给自己， 他们期望的结构如下:



![img](https://user-gold-cdn.xitu.io/2017/9/23/7a53472a451c2d48faf81c84024288ab?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)



注意 第一阶段 和 第二阶段的区别： 第一阶段， A部门想申请a.hello.com 下的子域名，需要向上级申请， 整个a.hello.com 域的管理都在总公司； 第二阶段， A部门先自己搭建nameserver，然后总公司把 a.hello.com 域管理权转交给 自建的nameserver， 这个转交管理权的行为，就叫 `子域授权`

子域授权分两部操作:

1. A部门自建nameserver, 并且在zone配置文件中指定a.hello.com 的 权威解析服务器为自己的nameserver地址
2. 总公司在nameserver 上增加一条NS记录， 把a.hello.com 域授权给A部门的nameserver

第一步我们在`用bind搭建域名解析服务器` 里讲过， 只要在 zone配置文件里指定SOA记录就好:

```
@       IN     SOA      ns.a.hello.com    admin.a.hello.com. (……)复制代码
```

第二步，在hello.com域的nameserver 上添加一条NS记录:

```
a.hello.com      IN       NS       ns.a.hello.com
ns.a.hello.com      IN      A        xx.xx.xx.xx (自建nameserver的IP)复制代码
```

这样当解析xx.a.hello.com 域名时， hello.com nameserver 发现配置中有NS记录，就会继续递归向下解析

# DNS 调试工具

OPS 常用的DNS调试工具有: host, nslookup, dig

这三个命令都属于 bind-utils 包， 也就是bind工具集， 它们的使用复杂度、功能 依次递增。 关于它们的使用， man 手册和网上有太多教程，这里简单分析一下dig命令的输出吧：



![img](https://user-gold-cdn.xitu.io/2017/9/23/3509832be6995eb9b009b4a664bc14af?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)



dig 的参数非常多， 功能也很多，详细使用方法大家自行man吧

# 其他

## DNS 放大攻击

DNS 放大攻击属于DoS攻击的一种，是通过大量流量占满目标机带宽， 使得目标机对正常用户的请求拒绝连接从而挂掉。

**思路**
正常的流量攻击，hack机向目标机建立大量request-response, 但这样存在的问题是需要大量的hack机器。 因为服务器一般的带宽远大于家用网络， 如果我们自己的家用机用来做hack机器，还没等目标机的带宽占满，我们的带宽早超载了。

**原理**
DNS 递归解析的流程比较特殊， 我们可以通过几个字节的query请求，换来几百甚至几千字节的resolving应答`（流量放大）`， 并且大部分服务器不会对DNS服务器做防御。 那么hacker们只要可以伪装DNS query包的source IP, 从而让DNS 服务器发送大量的response到目标机，就可以实现DoS攻击。



![img](data:image/svg+xml;utf8,<?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="800" height="600"></svg>)



但一般常用的DNS服务器都会对攻击请求做过滤，所以找DNS服务器漏洞也是一个问题。 详细的放大攻击方法大家有兴趣自行google吧，这里只做一个简单介绍 :)

## 好用的公共递归解析DNS服务器

见: [公共DNS哪家强](https://www.zhihu.com/question/32229915)

## 延伸

[如何用树莓派打造家用DNS](http://blog.lxx1.com/1770)



# 万字长文爆肝 DNS 协议！

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ddce2a50dd1e4607bda640a889afd189~tplv-k3u1fbpfcp-zoom-1.image)

试想一个问题，我们人类可以有多少种识别自己的方式？可以通过身份证来识别，可以通过社保卡号来识别，也可以通过驾驶证来识别，尽管我们有多种识别方式，但在特定的环境下，某种识别方法可能比另一种方法更为适合。因特网上的主机和人类一样，可以使用多种识别方式进行标识。互联网上主机的一种标识方法是使用它的 `主机名(hostname)` ，如 [www.facebook.com、](http://www.facebook.xn--com-6y3b/) [www.google.com](http://www.google.com/) 等。但是这是我们人类的记忆方式，路由器不会这么理解，路由器喜欢定长的、有层次结构的 `IP地址`。

如果你还不理解 IP 的话，可以翻阅一下我的这篇文章[计算机网络层](https://github.com/crisxuan/bestJavaer/blob/master/network/computer-internet.md)

IP 地址现在简单表述一下，就是一个由 4 字节组成，并有着严格的层次结构。例如 `121.7.106.83` 这样一个 IP 地址，其中的每个字节都可以用 `.` 进行分割，表示了 `0 - 255` 的十进制数字。

然而，路由器喜欢的是 IP 地址进行解析，我们人类却便于记忆的是网址，那么路由器如何把 IP 地址解析为我们熟悉的网址地址呢？这时候就需要 `DNS` 出现了。

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a6cad845c3b54c9aa66ff0c549766bdc~tplv-k3u1fbpfcp-zoom-1.image)

DNS 的全称是 `Domain Name System,DNS` ，它是一个由分层的 `DNS 服务器（DNS server）`实现的分布式数据库；它还是一个使得主机能够查询分布式数据库的应用层协议。DNS 服务器通常是运行 `BIND(Berkeley Internet Name Domain)` 软件的 UNIX 机器。DNS 协议运行在 `UDP` 之上，使用 53 端口。



## DNS 工作概述

假设运行在用户主机上的某些应用程序（如 Web 浏览器或邮件阅读器） 需要将主机名转换为 IP 地址。这些应用程序将调用 DNS 的客户端，并指明需要被转换的主机名。用户主机上的 DNS 收到后，会使用 UDP 通过 53 端口向网络上发送一个 DNS 查询报文，经过一段时间后，用户主机上的 DNS 会收到一个主机名对应的 DNS 回答报文。因此，从用户主机的角度来看，DNS 就像是一个黑盒子，其内部的操作你无法看到。但是实际上，实现 DNS 这个服务的黑盒子非常复杂，它由分布于全球的大量 DNS 服务器以及定义了 DNS 服务器与查询主机通信方式的应用层协议组成。

DNS 最早的设计是只有一台 DNS 服务器。这台服务器会包含所有的 DNS 映射。这是一种`集中式`的设计，这种设计并不适用于当今的互联网，因为互联网有着数量巨大并且持续增长的主机，这种集中式的设计会存在以下几个问题

- `单点故障(a single point of failure)`，如果 DNS 服务器崩溃，那么整个网络随之瘫痪。
- `通信容量(traaffic volume)`，单个 DNS 服务器不得不处理所有的 DNS 查询，这种查询级别可能是上百万上千万级
- `远距离集中式数据库(distant centralized database)`，单个 DNS 服务器不可能 `邻近` 所有的用户，假设在美国的 DNS 服务器不可能临近让澳大利亚的查询使用，其中查询请求势必会经过低速和拥堵的链路，造成严重的时延。
- `维护(maintenance)`，维护成本巨大，而且还需要频繁更新。

所以 DNS 不可能集中式设计，它完全没有可扩展能力，因此采用`分布式设计`，所以这种设计的特点如下

### 分布式、层次数据库

首先分布式设计首先解决的问题就是 DNS 服务器的扩展性问题，因此 DNS 使用了大量的 DNS 服务器，它们的组织模式一般是层次方式，并且分布在全世界范围内。**没有一台 DNS 服务器能够拥有因特网上所有主机的映射**。相反，这些映射分布在所有的 DNS 服务器上。

大致来说有三种 DNS 服务器：`根 DNS 服务器`、 `顶级域(Top-Level Domain, TLD) DNS 服务器` 和 `权威 DNS 服务器` 。这些服务器的层次模型如下图所示

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7b4cb7ab9dd548498b670701d9628aad~tplv-k3u1fbpfcp-zoom-1.image)

假设现在一个 DNS 客户端想要知道 [www.amazon.com](http://www.amazon.com/) 的 IP 地址，那么上面的域名服务器是如何解析的呢？首先，客户端会先根服务器之一进行关联，它将返回顶级域名 `com` 的 TLD 服务器的 IP 地址。该客户则与这些 TLD 服务器之一联系，它将为 amazon.com 返回权威服务器的 IP 地址。最后，该客户与 amazom.com 权威服务器之一联系，它为 [www.amazom.com](http://www.amazom.com/) 返回其 IP 地址。

### DNS 层次结构

我们现在来讨论一下上面域名服务器的层次系统

- `根 DNS 服务器` ，有 400 多个根域名服务器遍及全世界，这些根域名服务器由 13 个不同的组织管理。根域名服务器的清单和组织机构可以在 [root-servers.org/](https://root-servers.org/) 中找到，根域名服务器提供 TLD 服务器的 IP 地址。
- `顶级域 DNS 服务器`，对于每个顶级域名比如 com、org、net、edu 和 gov 和所有的国家级域名 uk、fr、ca 和 jp 都有 TLD 服务器或服务器集群。所有的顶级域列表参见 [tld-list.com/](https://tld-list.com/) 。TDL 服务器提供了权威 DNS 服务器的 IP 地址。
- `权威 DNS 服务器`，在因特网上具有公共可访问的主机，如 Web 服务器和邮件服务器，这些主机的组织机构必须提供可供访问的 DNS 记录，这些记录将这些主机的名字映射为 IP 地址。一个组织机构的权威 DNS 服务器收藏了这些 DNS 记录。

## DNS 查询步骤

下面我们描述一下 DNS 的查询步骤，从 DNS 解析 IP 再到 DNS 返回的一系列流程。

> 注意：通常情况下 DNS 会将查找的信息缓存在浏览器或者计算机本地中，如果有相同的请求到来时，就不再会进行 DNS 查找，而会直接返回结果。

通常情况下，DNS 的查找会经历下面这些步骤

1. 用户在浏览器中输入网址 `www.example.com` 并点击回车后，查询会进入网络，并且由 DNS 解析器进行接收。
2. DNS 解析器会向根域名发起查询请求，要求返回顶级域名的地址。
3. 根 DNS 服务器会注意到请求地址的前缀并向 DNS 解析器返回 com 的`顶级域名服务器(TLD)` 的 IP 地址列表。
4. 然后，DNS 解析器会向 TLD 服务器发送查询报文
5. TLD 服务器接收请求后，会根据域名的地址把`权威 DNS 服务器`的 IP 地址返回给 DNS 解析器。
6. 最后，DNS 解析器将查询直接发送到权威 DNS 服务器
7. 权威 DNS 服务器将 IP 地址返回给 DNS 解析器
8. DNS 解析器将会使用 IP 地址响应 Web 浏览器

一旦 DNS 查找的步骤返回了 example.com 的 IP 地址，浏览器就可以请求网页了。

整个流程如下图所示

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/424311059c5043418af799b75683dd95~tplv-k3u1fbpfcp-zoom-1.image)

### DNS 解析器

进行 DNS 查询的主机和软件叫做 `DNS 解析器`，用户所使用的工作站和个人电脑都属于解析器。一个解析器要至少注册一个以上域名服务器的 IP 地址。DNS 解析器是 DNS 查找的第一站，其**负责与发出初始请求的客户端打交道**。解析器启动查询序列，最终使 URL 转换为必要的 IP 地址。

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b782eda2422c48b3bb21f033bc207451~tplv-k3u1fbpfcp-zoom-1.image)

DNS 递归查询和 DNS 递归解析器不同，该查询是指向需要解析该查询的 DNS 解析器发出请求。DNS 递归解析器是一种计算机，其接受递归查询并通过发出必要的请求来处理响应。

### DNS 查询类型

DNS 查找中会出现三种类型的查询。通过组合使用这些查询，**优化的 DNS 解析过程可缩短传输距离**。在理想情况下，可以使用缓存的记录数据，从而使 DNS 域名服务器能够直接使用非递归查询。

1. `递归查询`：在递归查询中，DNS 客户端要求 DNS 服务器（一般为 DNS 递归解析器）将使用所请求的资源记录响应客户端，或者如果解析器无法找到该记录，则返回错误消息。

   ![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2f7a23db53024df9b58e9ef5051ed586~tplv-k3u1fbpfcp-zoom-1.image)

2. `迭代查询`：在迭代查询中，如果所查询的 DNS 服务器与查询名称不匹配，则其将返回对较低级别域名空间具有权威性的 DNS 服务器的引用。然后，DNS 客户端将对引用地址进行查询。此过程继续使用查询链中的其他 DNS 服务器，直至发生错误或超时为止。

   ![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/574852a4a19048c3857a4541701adbb1~tplv-k3u1fbpfcp-zoom-1.image)

3. `非递归查询`：当 DNS 解析器客户端查询 DNS 服务器以获取其有权访问的记录时通常会进行此查询，因为其对该记录具有权威性，或者该记录存在于其缓存内。DNS 服务器通常会缓存 DNS 记录，查询到来后能够直接返回缓存结果，以防止更多带宽消耗和上游服务器上的负载。

## DNS 缓存

`DNS 缓存(DNS caching)` 有时也叫做 `DNS 解析器缓存`，它是**由操作系统维护的临时数据库**，它包含有**最近的网站和其他 Internet 域的访问记录**。也就是说， DNS 缓存只是计算机为了满足快速的响应速度而把已加载过的资源缓存起来，再次访问时可以直接快速引用的一项技术和手段。那么 DNS 的缓存是如何工作的呢？

### DNS 缓存的工作流程

在浏览器向外部发出请求之前，计算机会拦截每个请求并在 DNS 缓存数据库中查找域名，该数据库包含有最近的域名列表，以及 DNS 首次发出请求时 DNS 为它们计算的地址。

### DNS 缓存方式

DNS 数据可缓存到各种不同的位置上，每个位置均将存储 DNS 记录，它的生存时间由 TTL(DNS 字段) 来决定。

#### 浏览器缓存

现如今的 Web 浏览器设计默认将 DNS 记录缓存一段时间。因为越靠近 Web 浏览器进行 DNS 缓存，为检查缓存并向 IP 地址发出请求的次数就越少。发出对 DNS 记录的请求时，浏览器缓存是针对所请求的记录而检查的第一个位置。

在 `chrome` 浏览器中，你可以使用 chrome://net-internals/#dns 查看 DNS 缓存的状态。这是基于 Windows 下查询的，我的 Mac 电脑输入上面 url 后无法查看 DNS ，只能 `clear host cache`，我也不知道为啥，可能是哪里设置的原因？

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3e6df32037d243a89633d5f6af7c84e9~tplv-k3u1fbpfcp-zoom-1.image)

#### 操作系统内核缓存

在浏览器缓存查询后，会进行操作系统级 DNS 解析器的查询，操作系统级 DNS 解析器是 DNS 查询离开你的计算机前的第二站，也是本地查询的最后一个步骤。

## DNS 报文

共同实现 DNS 分布式数据库的所有 DNS 服务器存储了`资源记录(Resource Record, RR)`，RR 提供了主机名到 IP 地址的映射。每个 DNS 回答报文中会包含一条或多条资源记录。RR 记录用于回复客户端查询。

资源记录是一个包含了下列字段的 4 元组

```
(Name, Value, Type, TTL)
复制代码
```

RR 会有不同的类型，下面是不同类型的 RR 汇总表

| DNS RR 类型 | 解释                                        |
| :---------- | :------------------------------------------ |
| A 记录      | IPv4 主机记录，用于将域名映射到 IPv4 地址   |
| AAAA 记录   | IPv6 主机记录，用于将域名映射到 IPv6 地址   |
| CNAME 记录  | 别名记录，用于映射 DNS 域名的别名           |
| MX 记录     | 邮件交换器，用于将 DNS 域名映射到邮件服务器 |
| PTR 记录    | 指针，用于反向查找（IP地址到域名解析）      |
| SRV 记录    | SRV记录，用于映射可用服务。                 |

DNS 有两种报文，一种是查询报文，一种是响应报文，并且这两种报文有着相同的格式，下面是 DNS 的报文格式

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7317816bbef44e08bb749c3345ba54a9~tplv-k3u1fbpfcp-zoom-1.image)

上图显示了 DNS 的报文格式，其中事务 ID、标志、问题数量、回答资源记录数、权威名称服务器计数、附加资源记录数这六个字段是 DNS 的报文段首部，报文段首部一共有 12 个字节。

### 报文段首部

报文段首部是 DNS 报文的基础结构部分，下面我们对报文段首部中的每个字节进行描述

- 事务 ID: 事务 ID 占用 2 个字节。它是 DNS 的标识，又叫做 `标识符`，对于请求报文和响应报文来说，这个字段的值是一样的，通过标识符可以区分 DNS 应答报文是对哪个请求进行响应的。
- 标志：标志字段占用 2 个字节。标志字段有很多，而且也比较重要，下面列出来了所有的标志字段。

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d3432d8e8cc04ab28626dac21dc9df90~tplv-k3u1fbpfcp-zoom-1.image)

每个字段的含义如下

- `QR(Response)`: 1 bit 的 QR 标识报文是查询报文还是响应报文，查询报文时 QR = 0，响应报文时 QR = 1。
- `OpCode`: 4 bit 的 OpCode 表示操作码，其中，0 表示标准查询，1 表示反向查询，2 表示服务器状态请求。
- `AA(Authoritative)`: 1 bit 的 AA 代表授权应答，这个 AA 只在响应报文中有效，值为 1 时，表示名称服务器是权威服务器；值为 0 时，表示不是权威服务器。
- `TC(Truncated)`: 截断标志位，值为 1 时，表示响应已超过 512 字节并且已经被截断，只返回前 512 个字节。
- `RD(Recursion Desired)`: 这个字段是期望递归字段，该字段在查询中设置，并在响应中返回。该标志告诉名称服务器必须处理这个查询，这种方式被称为一个递归查询。如果该位为 0，且被请求的名称服务器没有一个授权回答，它将返回一个能解答该查询的其他名称服务器列表。这种方式被称为迭代查询。
- `RA(Recursion Available)`: 可用递归字段，这个字段只出现在响应报文中。当值为 1 时，表示服务器支持递归查询。
- `zero`: 保留字段，在所有的请求和应答报文中，它的值必须为 0。
- `AD`: 这个字段表示信息是否是已授权。
- `CD`: 这个字段表示是否禁用安全检查。

- `rcode（Reply code）`：这个字段是返回码字段，表示响应的差错状态。当值为 0 时，表示没有错误；当值为 1 时，表示报文格式错误（Format error），服务器不能理解请求的报文；当值为 2 时，表示域名服务器失败（Server failure），因为服务器的原因导致没办法处理这个请求；当值为 3 时，表示名字错误（Name Error），只有对授权域名解析服务器有意义，指出解析的域名不存在；当值为 4 时，表示查询类型不支持（Not Implemented），即域名服务器不支持查询类型；当值为 5 时，表示拒绝（Refused），一般是服务器由于设置的策略拒绝给出应答，如服务器不希望对某些请求者给出应答。

相信读者跟我一样，只看这些字段没什么意思，下面我们就通过抓包的方式，看一下具体的 DNS 报文。

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/957f2ddf7b1e4bf1b421314100f9e688~tplv-k3u1fbpfcp-zoom-1.image)

现在我们可以看一下具体的 DNS 报文，通过 `query` 可知这是一个请求报文，这个报文的标识符是 `0xcd28`，它的标志如下

- QR = 0 实锤了这就是一个请求。
- 然后是四个字节的 OpCode，它的值是 0，表示这是一个标准查询。
- 因为这是一个查询请求，所以没有 AA 字段出现。
- 然后是截断标志位 Truncated，表示没有被截断。
- 紧随其后的 RD = 1，表示希望得到递归回答。
- 请求报文中没有 RA 字段出现。
- 然后是保留字段 zero。
- 紧随其后的 0 表示未经身份验证的数据是不可接受的。
- 没有 rcode 字段的值

然后我们看一下响应报文

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/76a6984272eb42bbad3b94b5aab0bcbc~tplv-k3u1fbpfcp-zoom-1.image)

可以看到，标志位也是 `0xcd28`，可以说明这就是上面查询请求的响应。

查询请求已经解释过的报文我们这里就不再说明了，现在只解释一下请求报文中没有的内容

- 紧随在 OpCode 后面的 AA 字段已经出现了，它的值为 0 ，表示不是权威 DNS 服务器的响应
- 最后是 rcode 字段的响应，值为 0 时，表示没有错误。

### 问题区域

问题区域通常指报文格式中查询问题的区域部分。这部分用来显示 DNS 查询请求的问题，包括查询类型和查询类

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e3a18c8219f84f88bb4c717464b82774~tplv-k3u1fbpfcp-zoom-1.image)

这部分中每个字段的含义如下

- 查询名：指定要查询的域名，有时候也是 IP 地址，用于反向查询。
- 查询类型：DNS 查询请求的资源类型，通常查询类型为 A 类型，表示由域名获取对应的 IP 地址。
- 查询类：地址类型，通常为互联网地址，值为 1 。

同样的，我们再使用 wireshark 查看一下问题区域

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6d33e5a242f848389a8e3b8e3e42cc93~tplv-k3u1fbpfcp-zoom-1.image)

可以看到，这是对 mobile-gtalk.l.google.com 发起的 DNS 查询请求，查询类型是 A，那么得到的响应类型应该也是 A

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/52690478c90e4eb4a96d4466a18b3568~tplv-k3u1fbpfcp-zoom-1.image)

如上图所示，响应类型是 A ，查询类的值通常是 1、254 和 255，分别表示互联网类、没有此类和所有类，这些是我们感兴趣的值，其他值通常不用于 TCP/IP 网络。

### 资源记录部分

资源记录部分是 DNS 报文的最后三个字段，包括回答问题区域、权威名称服务器记录、附加信息区域，这三个字段均采用一种称为资源记录的格式，如下图所示

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2f3bf65d1478496e807e29573439f73c~tplv-k3u1fbpfcp-zoom-1.image)

资源记录部分的字段含义如下

- 域名：DNS 请求的域名。
- 类型：资源记录的类型，与问题部分中的查询类型值是一样的。
- 类：地址类型、与问题中的查询类值一样的。
- 生存时间：以秒为单位，表示资源记录的生命周期。
- 资源数据长度：资源数据的长度。
- 资源数据：表示按查询段要求返回的相关资源记录的数据。

资源记录部分只有在 DNS 响应包中才会出现。下面我们就来通过响应报文看一下具体的字段示例

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1d154021a972480bb95a55cd4bdf425e~tplv-k3u1fbpfcp-zoom-1.image)

其中，域名的值是 mobile-gtalk.l.google.com ，类型是 A，类是 1，生存时间是 5 秒，数据长度是 4 字节，资源数据表示的地址是 63.233.189.188。

### SOA 记录

如果是权威 DNS 服务器的响应的话，会显示记录存储有关区域的重要信息，这种信息就是 `SOA` 记录。所有 的DNS 区域都需要一个 SOA 记录才能符合 IETF 标准。 SOA 记录对于区域传输也很重要。

SOA 记录除具有 DNS 解析器响应的字段外，还具有一些额外的字段，如下

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4f5b6e518ed04268880c9f36aad1a669~tplv-k3u1fbpfcp-zoom-1.image)

具体字段含义

- `PNAME`：即 Primary Name Server，这是区域的主要名称服务器的名称。
- `RNAME`：即 Responsible authority's mailbox，RNAME 代表管理员的电子邮件地址，@ 用 . 来表示，也就是说 admin.example.com 等同于 [admin@example.com](mailto:admin@example.com)。
- `序列号`： 即 Serial Number ，区域序列号是该区域的唯一标识符。
- `刷新间隔`：即 Refresh Interval，在请求主服务器提供 SOA 记录以查看其是否已更新之前，辅助服务器应等待的时间（以秒为单位）。
- `重试间隔`：服务器应等待无响应的主要名称服务器再次请求更新的时间。
- `过期限制`：如果辅助服务器在这段时间内没有收到主服务器的响应，则应停止响应对该区域的查询。

上面提到了主要名称服务器和服务名称服务器，他们之间的关系如下

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/23b05c6c58344dc3aad0e75c2eb1572d~tplv-k3u1fbpfcp-zoom-1.image)

这块我们主要解释了 RR 类型为 A(IPv4) 和 SOA 的记录，除此之外还有很多类型，这篇文章就不再详细介绍了，读者朋友们可以阅读 《TCP/IP 卷一 协议》和 cloudflare 的官网 [www.cloudflare.com/learning/dn…](https://www.cloudflare.com/learning/dns/dns-records/) 查阅，值得一提的是，cloudflare 是一个学习网络协议非常好的网站。

## DNS 安全

几乎所有的网络请求都会经过 DNS 查询，而且 DNS 和许多其他的 Internet 协议一样，系统设计时并未考虑到安全性，并且存在一些设计限制，这为 DNS 攻击创造了机会。

DNS 攻击主要有下面这几种方式

- 第一种是 `Dos 攻击`，这种攻击的主要形式是使重要的 DNS 服务器比如 TLD 服务器或者根域名服务器过载，从而无法响应权威服务器的请求，使 DNS 查询不起作用。
- 第二种攻击形式是 `DNS 欺骗`，通过改变 DNS 资源内容，比如伪装一个官方的 DNS 服务器，回复假的资源记录，从而导致主机在尝试与另一台机器连接时，连接至错误的 IP 地址。
- 第三种攻击形式是 `DNS 隧道`，这种攻击使用其他网络协议通过 DNS 查询和响应建立隧道。攻击者可以使用 SSH、TCP 或者 HTTP 将恶意软件或者被盗信息传递到 DNS 查询中，这种方式使防火墙无法检测到，从而形成 DNS 攻击。
- 第四种攻击形式是 `DNS 劫持`，在 DNS 劫持中，攻击者将查询重定向到其他域名服务器。这可以通过恶意软件或未经授权的 DNS 服务器修改来完成。尽管结果类似于 DNS 欺骗，但这是完全不同的攻击，因为它的目标是名称服务器上网站的 DNS 记录，而不是解析程序的缓存。
- 第五章攻击形式是 `DDoS 攻击`，也叫做分布式拒绝服务带宽洪泛攻击，这种攻击形式相当于是 Dos 攻击的升级版

> 那么该如何防御 DNS 攻击呢？

防御 DNS 威胁的最广为人知的方法之一就是采用 `DNSSEC 协议`。

### DNSSEC

DNSSEC 又叫做 `DNS 安全扩展`，DNSSEC 通过对数据进行`数字签名`来保护其有效性，从而防止受到攻击。它是由 IETF 提供的一系列 DNS 安全认证的机制。DNSSEC 不会对数据进行加密，它只会验证你所访问的站点地址是否有效。

### DNS 防火墙

有一些攻击是针对服务器进行的，这就需要 DNS 防火墙的登场了，`DNS 防火墙`是一种可以为 DNS 服务器提供许多安全和性能服务的工具。DNS 防火墙位于用户的 DNS 解析器和他们尝试访问的网站或服务的权威名称服务器之间。防火墙提供 `限速访问`，以关闭试图淹没服务器的攻击者。如果服务器确实由于攻击或任何其他原因而导致停机，则 DNS 防火墙可以通过提供来自缓存的 DNS 响应来使操作员的站点或服务正常运行。

除了上述两种防御手段外，本身 DNS 区域的运营商就会采取进步一措施保护 DNS 服务器，比如配置 DNS 基础架构，来防止 DDoS 攻击。

更多关于 DNS 的攻击和防御就是网络安全的主题，这篇文章就不再详细介绍了。

## 总结

这篇文章我用较多的字数为你介绍了 DNS 的基本概述，DNS 的工作机制，DNS 的查询方式，DNS 的缓存机制，我们还通过 WireShark 抓包带你认识了一下 DNS 的报文，最后我为你介绍了 DNS 的攻击手段和防御方式。

这是一篇入门 DNS 较全的文章，花了我一周多的时间来写这篇文章，这篇文章了解清楚后，基本上 DNS 的大部分问题你应该都能够回答，面试我估计也稳了。