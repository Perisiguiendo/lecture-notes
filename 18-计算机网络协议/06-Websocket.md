# é›¶è·ç¦»æ¥è§¦websocketğŸš€

### ä»€ä¹ˆæ˜¯WebSocket

#### å®šä¹‰

Websocketæ˜¯ä¸€ä¸ªæŒä¹…åŒ–çš„ç½‘ç»œé€šä¿¡åè®®ï¼Œå¯ä»¥åœ¨å•ä¸ª TCP è¿æ¥ä¸Šè¿›è¡Œ`å…¨åŒå·¥é€šè®¯`ï¼Œæ²¡æœ‰äº†`Request`å’Œ`Response`çš„æ¦‚å¿µï¼Œä¸¤è€…åœ°ä½å®Œå…¨å¹³ç­‰ï¼Œè¿æ¥ä¸€æ—¦å»ºç«‹ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¹‹é—´å®æ—¶å¯ä»¥è¿›è¡ŒåŒå‘æ•°æ®ä¼ è¾“

#### å…³è”å’ŒåŒºåˆ«

- **HTTP**

1. HTTPæ˜¯éæŒä¹…çš„åè®®ï¼Œå®¢æˆ·ç«¯æƒ³çŸ¥é“æœåŠ¡ç«¯çš„å¤„ç†è¿›åº¦åªèƒ½é€šè¿‡ä¸åœåœ°ä½¿ç”¨ `Ajax`è¿›è¡Œè½®è¯¢æˆ–è€…é‡‡ç”¨ `long poll` çš„æ–¹å¼æ¥ï¼Œä½†æ˜¯å‰è€…å¯¹æœåŠ¡å™¨å‹åŠ›å¤§ï¼Œåè€…åˆ™ä¼šå› ä¸ºä¸€ç›´ç­‰å¾…Responseé€ æˆé˜»å¡ ![img](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2308134eee1949129438e15b945792b9~tplv-k3u1fbpfcp-zoom-1.image)
2. è™½ç„¶http1.1é»˜è®¤å¼€å¯äº†`keep-alive`é•¿è¿æ¥ä¿æŒäº†è¿™ä¸ª`TCPé€šé“`ä½¿å¾—åœ¨ä¸€ä¸ªHTTPè¿æ¥ä¸­ï¼Œå¯ä»¥å‘é€å¤šä¸ªRequestï¼Œæ¥æ”¶å¤šä¸ªResponseï¼Œä½†æ˜¯ä¸€ä¸ªrequeståªèƒ½æœ‰ä¸€ä¸ªresponseã€‚è€Œä¸”è¿™ä¸ªresponseä¹Ÿæ˜¯è¢«åŠ¨çš„ï¼Œä¸èƒ½ä¸»åŠ¨å‘èµ·ã€‚
3. websocketè™½ç„¶æ˜¯ç‹¬ç«‹äºHTTPçš„ä¸€ç§åè®®ï¼Œä½†æ˜¯websocketå¿…é¡»ä¾èµ– HTTP åè®®è¿›è¡Œä¸€æ¬¡`æ¡æ‰‹`(åœ¨æ¡æ‰‹é˜¶æ®µæ˜¯ä¸€æ ·çš„)ï¼Œæ¡æ‰‹æˆåŠŸåï¼Œæ•°æ®å°±ç›´æ¥ä» TCPé€šé“ä¼ è¾“ï¼Œä¸ HTTP æ— å…³äº†ï¼Œå¯ä»¥ç”¨ä¸€å¼ å›¾ç†è§£ä¸¤è€…æœ‰äº¤é›†ï¼Œä½†æ˜¯å¹¶ä¸æ˜¯å…¨éƒ¨ã€‚ ![img](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/93f1390c965f4bb28f97eeced69652d0~tplv-k3u1fbpfcp-zoom-1.image)

- **socket**

1. socketä¹Ÿè¢«ç§°ä¸º`å¥—æ¥å­—`ï¼Œä¸HTTPå’ŒWebSocketä¸ä¸€æ ·ï¼Œsocketä¸æ˜¯åè®®ï¼Œå®ƒæ˜¯åœ¨ç¨‹åºå±‚é¢ä¸Šå¯¹ä¼ è¾“å±‚åè®®ï¼ˆå¯ä»¥ä¸»è¦ç†è§£ä¸ºTCP/IPï¼‰çš„æ¥å£å°è£…ã€‚å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªèƒ½å¤Ÿæä¾›ç«¯å¯¹ç«¯çš„é€šä¿¡çš„è°ƒç”¨æ¥å£ï¼ˆAPIï¼‰
2. å¯¹äºç¨‹åºå‘˜è€Œè¨€ï¼Œå…¶éœ€è¦åœ¨ A ç«¯åˆ›å»ºä¸€ä¸ª socket å®ä¾‹ï¼Œå¹¶ä¸ºè¿™ä¸ªå®ä¾‹æä¾›å…¶æ‰€è¦è¿æ¥çš„ B ç«¯çš„ IP åœ°å€å’Œç«¯å£å·ï¼Œè€Œåœ¨ B ç«¯åˆ›å»ºå¦ä¸€ä¸ª socket å®ä¾‹ï¼Œå¹¶ä¸”ç»‘å®šæœ¬åœ°ç«¯å£å·æ¥è¿›è¡Œç›‘å¬ã€‚å½“ A å’Œ B å»ºç«‹è¿æ¥åï¼ŒåŒæ–¹å°±å»ºç«‹äº†ä¸€ä¸ªç«¯å¯¹ç«¯çš„ TCP è¿æ¥ï¼Œä»è€Œå¯ä»¥è¿›è¡ŒåŒå‘é€šä¿¡ã€‚WebSocektå€Ÿé‰´äº† socket çš„æ€æƒ³ï¼Œä¸º client å’Œ server ä¹‹é—´æä¾›äº†ç±»ä¼¼çš„åŒå‘é€šä¿¡æœºåˆ¶

#### åº”ç”¨åœºæ™¯

WebSocketå¯ä»¥åšå¼¹å¹•ã€æ¶ˆæ¯è®¢é˜…ã€å¤šç©å®¶æ¸¸æˆã€ååŒç¼–è¾‘ã€è‚¡ç¥¨åŸºé‡‘å®æ—¶æŠ¥ä»·ã€è§†é¢‘ä¼šè®®ã€åœ¨çº¿æ•™è‚²ã€èŠå¤©å®¤ç­‰åº”ç”¨å®æ—¶ç›‘å¬æœåŠ¡ç«¯å˜åŒ–

### Websocketæ¡æ‰‹

- Websocketæ¡æ‰‹è¯·æ±‚æŠ¥æ–‡ï¼š

```
GET /chat HTTP/1.1
Host: server.example.com
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Key: x3JJHMbDL1EzLkh9GBhXDw==
Sec-WebSocket-Protocol: chat, superchat
Sec-WebSocket-Version: 13
Origin: http://example.com
å¤åˆ¶ä»£ç 
```

ä¸‹é¢æ˜¯ä¸ä¼ ç»Ÿ HTTP æŠ¥æ–‡ä¸åŒçš„åœ°æ–¹ï¼š

```
Upgrade: websocket
Connection: Upgrade
å¤åˆ¶ä»£ç 
```

è¡¨ç¤ºå‘èµ·çš„æ˜¯ WebSocket åè®®

```
Sec-WebSocket-Key: x3JJHMbDL1EzLkh9GBhXDw==
Sec-WebSocket-Protocol: chat, superchat
Sec-WebSocket-Version: 13
å¤åˆ¶ä»£ç 
```

**Sec-WebSocket-Key** æ˜¯ç”±æµè§ˆå™¨éšæœºç”Ÿæˆçš„ï¼ŒéªŒè¯æ˜¯å¦å¯ä»¥è¿›è¡ŒWebsocketé€šä¿¡ï¼Œé˜²æ­¢æ¶æ„æˆ–è€…æ— æ„çš„è¿æ¥ã€‚

**Sec_WebSocket-Protocol** æ˜¯ç”¨æˆ·è‡ªå®šä¹‰çš„å­—ç¬¦ä¸²ï¼Œç”¨æ¥æ ‡è¯†æœåŠ¡æ‰€éœ€è¦çš„åè®®

**Sec-WebSocket-Version** è¡¨ç¤ºæ”¯æŒçš„ WebSocket ç‰ˆæœ¬ã€‚

- æœåŠ¡å™¨å“åº”ï¼š

```
HTTP/1.1 101 Switching Protocols
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Accept: HSmrc0sMlYUkAGmm5OPpG2HaGWk=
Sec-WebSocket-Protocol: chat
å¤åˆ¶ä»£ç 
```

**101 å“åº”ç ** è¡¨ç¤ºè¦è½¬æ¢åè®®ã€‚

**Connection: Upgrade** è¡¨ç¤ºå‡çº§æ–°åè®®è¯·æ±‚ã€‚

**Upgrade: websocket** è¡¨ç¤ºå‡çº§ä¸º WebSocket åè®®ã€‚

**Sec-WebSocket-Accept** æ˜¯ç»è¿‡æœåŠ¡å™¨ç¡®è®¤ï¼Œå¹¶ä¸”åŠ å¯†è¿‡åçš„ Sec-WebSocket-Keyã€‚ç”¨æ¥è¯æ˜å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´èƒ½è¿›è¡Œé€šä¿¡äº†ã€‚

**Sec-WebSocket-Protocol** è¡¨ç¤ºæœ€ç»ˆä½¿ç”¨çš„åè®®ã€‚

è‡³æ­¤ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨æ¡æ‰‹æˆåŠŸå»ºç«‹äº†Websocketè¿æ¥ï¼ŒHTTPå·²ç»å®Œæˆå®ƒæ‰€æœ‰å·¥ä½œäº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯å®Œå…¨æŒ‰ç…§Websocketåè®®è¿›è¡Œé€šä¿¡äº†ã€‚

### å…³äºWebsocket

#### WebSocketå¿ƒè·³

å¯èƒ½ä¼šæœ‰ä¸€äº›æœªçŸ¥æƒ…å†µå¯¼è‡´SOCKETæ–­å¼€ï¼Œè€Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å´ä¸çŸ¥é“ï¼Œéœ€è¦å®¢æˆ·ç«¯å®šæ—¶å‘é€ä¸€ä¸ª`å¿ƒè·³ Ping` è®©æœåŠ¡ç«¯çŸ¥é“è‡ªå·±åœ¨çº¿ï¼Œè€ŒæœåŠ¡ç«¯ä¹Ÿè¦å›å¤ä¸€ä¸ª`å¿ƒè·³ Pong`å‘Šè¯‰å®¢æˆ·ç«¯è‡ªå·±å¯ç”¨ï¼Œå¦åˆ™è§†ä¸ºæ–­å¼€

#### WebSocketçŠ¶æ€

WebSocket å¯¹è±¡ä¸­çš„readyStateå±æ€§æœ‰å››ç§çŠ¶æ€ï¼š

- 0: è¡¨ç¤ºæ­£åœ¨è¿æ¥
- 1: è¡¨ç¤ºè¿æ¥æˆåŠŸï¼Œå¯ä»¥é€šä¿¡äº†
- 2: è¡¨ç¤ºè¿æ¥æ­£åœ¨å…³é—­
- 3: è¡¨ç¤ºè¿æ¥å·²ç»å…³é—­ï¼Œæˆ–è€…æ‰“å¼€è¿æ¥å¤±è´¥

### WebSocketå®è·µ

#### æœåŠ¡ç«¯æ¥æ”¶å‘é€æ¶ˆæ¯

WebSocketçš„æœåŠ¡ç«¯éƒ¨åˆ†ï¼Œæœ¬æ–‡ä¼šä»¥Node.jsæ­å»º

å®‰è£…`express`å’Œè´Ÿè´£å¤„ç†WebSocketåè®®çš„`ws`ï¼š

```
npm install express ws
å¤åˆ¶ä»£ç 
```

å®‰è£…æˆåŠŸåçš„package.json:

![img](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f6d06563f597411698f354acd4eda279~tplv-k3u1fbpfcp-zoom-1.image)

æ¥ç€åœ¨æ ¹ç›®å½•åˆ›å»ºserver.jsæ–‡ä»¶:

```
//å¼•å…¥express å’Œ ws
const express = require('express');
const SocketServer = require('ws').Server;

//æŒ‡å®šå¼€å¯çš„ç«¯å£å·
const PORT = 3000;

// åˆ›å»ºexpressï¼Œç»‘å®šç›‘å¬3000ç«¯å£ï¼Œä¸”è®¾å®šå¼€å¯ååœ¨consolä¸­æç¤º
const server = express().listen(PORT, () => console.log(`Listening on ${PORT}`));

// å°†expressäº¤ç»™SocketServerå¼€å¯WebSocketçš„æœåŠ¡
const wss = new SocketServer({ server });

//å½“ WebSocket ä»å¤–éƒ¨è¿æ¥æ—¶æ‰§è¡Œ
wss.on('connection', (ws) => {
  //è¿æ¥æ—¶æ‰§è¡Œæ­¤ console æç¤º
  console.log('Client connected');

  // å¯¹messageè®¾ç½®ç›‘å¬ï¼Œæ¥æ”¶ä»å®¢æˆ·ç«¯å‘é€çš„æ¶ˆæ¯
  ws.on('message', (data) => {
    //dataä¸ºå®¢æˆ·ç«¯å‘é€çš„æ¶ˆæ¯ï¼Œå°†æ¶ˆæ¯åŸå°ä¸åŠ¨è¿”å›å›å»
    ws.send(data);
  });

  // å½“WebSocketçš„è¿æ¥å…³é—­æ—¶æ‰§è¡Œ
  ws.on('close', () => {
    console.log('Close connected');
  });
});
å¤åˆ¶ä»£ç 
```

æ‰§è¡Œnode server.jså¯åŠ¨æœåŠ¡ï¼Œç«¯å£æ‰“å¼€åä¼šæ‰§è¡Œç›‘å¬æ—¶é—´æ‰“å°æç¤ºï¼Œè¯´æ˜æœåŠ¡å¯åŠ¨æˆåŠŸ

![img](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c183ba66addf4e05ac592959ed9f88c6~tplv-k3u1fbpfcp-zoom-1.image)

åœ¨å¼€å¯WebSocketåï¼ŒæœåŠ¡ç«¯ä¼šåœ¨messageä¸­ç›‘å¬ï¼Œæ¥æ”¶å‚æ•°dataæ•è·å®¢æˆ·ç«¯å‘é€çš„æ¶ˆæ¯ï¼Œç„¶åä½¿ç”¨sendå‘é€æ¶ˆæ¯

#### å®¢æˆ·ç«¯æ¥æ”¶å‘é€æ¶ˆæ¯

åˆ†åˆ«åœ¨æ ¹ç›®å½•åˆ›å»ºindex.htmlå’Œindex.jsæ–‡ä»¶

- index.html

```
<html>
  <body>
    <script src="./index.js"></script>
  </body>
</html>
å¤åˆ¶ä»£ç 
```

- index.js

```
// ä½¿ç”¨WebSocketçš„åœ°å€å‘æœåŠ¡ç«¯å¼€å¯è¿æ¥
let ws = new WebSocket('ws://localhost:3000');

// å¼€å¯åçš„åŠ¨ä½œï¼ŒæŒ‡å®šåœ¨è¿æ¥åæ‰§è¡Œçš„äº‹ä»¶
ws.onopen = () => {
  console.log('open connection');
};

// æ¥æ”¶æœåŠ¡ç«¯å‘é€çš„æ¶ˆæ¯
ws.onmessage = (event) => {
  console.log(event);
};

// æŒ‡å®šåœ¨å…³é—­åæ‰§è¡Œçš„äº‹ä»¶
ws.onclose = () => {
  console.log('close connection');
};
å¤åˆ¶ä»£ç 
```

ä¸Šé¢çš„`url`å°±æ˜¯æœ¬æœº`node`å¼€å¯çš„æœåŠ¡åœ°å€ï¼Œåˆ†åˆ«æŒ‡å®šè¿æ¥ï¼ˆonopenï¼‰ï¼Œå…³é—­ï¼ˆoncloseï¼‰å’Œæ¶ˆæ¯æ¥æ”¶ï¼ˆonmessageï¼‰çš„æ‰§è¡Œäº‹ä»¶ï¼Œè®¿é—®htmlï¼Œæ‰“å°wsä¿¡æ¯

![img](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5cb22cc2e46c43a4bdf87f6095cb8d54~tplv-k3u1fbpfcp-zoom-1.image)

æ‰“å°äº†`open connection`è¯´æ˜è¿æ¥æˆåŠŸï¼Œå®¢æˆ·ç«¯ä¼šä½¿ç”¨`onmessage`å¤„ç†æ¥æ”¶

å…¶ä¸­`event`å‚æ•°åŒ…å«è¿™æ¬¡æ²Ÿé€šçš„è¯¦ç»†ä¿¡æ¯ï¼Œä»æœåŠ¡ç«¯å›ä¼ çš„æ¶ˆæ¯ä¼šåœ¨eventçš„dataå±æ€§ä¸­ã€‚

æ‰‹åŠ¨åœ¨æ§åˆ¶å°è°ƒç”¨`send`å‘é€æ¶ˆæ¯ï¼Œæ‰“å°eventå›ä¼ ä¿¡æ¯:

![img](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9c7d7bbb10d0464cbe37ddb4e5b36d21~tplv-k3u1fbpfcp-zoom-1.image)

#### æœåŠ¡ç«¯å®šæ—¶å‘é€

ä¸Šé¢æ˜¯ä»å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯ï¼ŒæœåŠ¡ç«¯å›ä¼ ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡`setInterval`è®©æœåŠ¡ç«¯åœ¨å›ºå®šæ—¶é—´å‘é€æ¶ˆæ¯ç»™å®¢æˆ·ç«¯:

server.jsä¿®æ”¹å¦‚ä¸‹:

```
//å½“WebSocketä»å¤–éƒ¨è¿æ¥æ—¶æ‰§è¡Œ
wss.on('connection', (ws) => {
  //è¿æ¥æ—¶æ‰§è¡Œæ­¤ console æç¤º
  console.log('Client connected');

+  //å›ºå®šå‘é€æœ€æ–°æ¶ˆæ¯ç»™å®¢æˆ·ç«¯
+  const sendNowTime = setInterval(() => {
+    ws.send(String(new Date()));
+  }, 1000);

-  //å¯¹messageè®¾ç½®ç›‘å¬ï¼Œæ¥æ”¶ä»å®¢æˆ·ç«¯å‘é€çš„æ¶ˆæ¯
-  ws.on('message', (data) => {
-    //dataä¸ºå®¢æˆ·ç«¯å‘é€çš„æ¶ˆæ¯ï¼Œå°†æ¶ˆæ¯åŸå°ä¸åŠ¨è¿”å›å›å»
-    ws.send(data);
-  });

  //å½“ WebSocketçš„è¿æ¥å…³é—­æ—¶æ‰§è¡Œ
  ws.on('close', () => {
    console.log('Close connected');
  });
});
å¤åˆ¶ä»£ç 
```

å®¢æˆ·ç«¯è¿æ¥åå°±ä¼šå®šæ—¶æ¥æ”¶ï¼Œç›´è‡³æˆ‘ä»¬å…³é—­websocketæœåŠ¡

![img](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2d17c7333f0a4c428b22e9bf85ab3781~tplv-k3u1fbpfcp-zoom-1.image)

#### å¤šäººèŠå¤©

å¦‚æœå¤šä¸ªå®¢æˆ·ç«¯è¿æ¥æŒ‰ç…§ä¸Šé¢çš„æ–¹å¼åªä¼šè¿”å›å„è‡ªå‘é€çš„æ¶ˆæ¯ï¼Œå…ˆæ³¨é‡ŠæœåŠ¡ç«¯å®šæ—¶å‘é€ï¼Œå¼€å¯ä¸¤ä¸ªçª—å£æ¨¡æ‹Ÿï¼š

![img](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6c770e9d0ebd415abeb5686bcfc31d0b~tplv-k3u1fbpfcp-zoom-1.image)

å¦‚æœæˆ‘ä»¬è¦è®©å®¢æˆ·ç«¯é—´æ¶ˆæ¯å…±äº«ï¼Œä¹ŸåŒæ—¶æ¥æ”¶åˆ°æœåŠ¡ç«¯å›ä¼ çš„æ¶ˆæ¯å‘¢ï¼Ÿ

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨`clients`æ‰¾å‡ºå½“å‰æ‰€æœ‰è¿æ¥ä¸­çš„å®¢æˆ·ç«¯ ï¼Œå¹¶é€šè¿‡å›ä¼ æ¶ˆæ¯å‘é€åˆ°æ¯ä¸€ä¸ªå®¢æˆ·ç«¯ ä¸­ï¼š

ä¿®æ”¹server.jså¦‚ä¸‹:

```
...

//å½“WebSocketä»å¤–éƒ¨è¿æ¥æ—¶æ‰§è¡Œ
wss.on('connection', (ws) => {
  //è¿æ¥æ—¶æ‰§è¡Œæ­¤ console æç¤º
  console.log('Client connected');

-  //å›ºå®šå‘é€æœ€æ–°æ¶ˆæ¯ç»™å®¢æˆ·ç«¯
-  const sendNowTime = setInterval(() => {
-    ws.send(String(new Date()));
- }, 1000);

+  //å¯¹messageè®¾ç½®ç›‘å¬ï¼Œæ¥æ”¶ä»å®¢æˆ·ç«¯å‘é€çš„æ¶ˆæ¯
+   ws.on('message', (data) => {
+    //å–å¾—æ‰€æœ‰è¿æ¥ä¸­çš„ å®¢æˆ·ç«¯
+    let clients = wss.clients;
+    //å¾ªç¯ï¼Œå‘é€æ¶ˆæ¯è‡³æ¯ä¸ªå®¢æˆ·ç«¯
+    clients.forEach((client) => {
+      client.send(data);
+    });
+   });

  //å½“WebSocketçš„è¿æ¥å…³é—­æ—¶æ‰§è¡Œ
  ws.on('close', () => {
    console.log('Close connected');
  });
});
å¤åˆ¶ä»£ç 
```

è¿™æ ·ä¸€æ¥ï¼Œä¸è®ºåœ¨å“ªä¸ªå®¢æˆ·ç«¯å‘é€æ¶ˆæ¯ï¼ŒæœåŠ¡ç«¯éƒ½èƒ½å°†æ¶ˆæ¯å›ä¼ åˆ°æ¯ä¸ªå®¢æˆ·ç«¯ ï¼š ![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/007495393def4861a410d314a5b49a4e~tplv-k3u1fbpfcp-zoom-1.image) å¯ä»¥è§‚å¯Ÿä¸‹è¿æ¥ä¿¡æ¯: ![img](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a17ca22d9b1645e7a3f723b082e721fa~tplv-k3u1fbpfcp-zoom-1.image)

![img](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fcb4d122ba4c4445a4814041620a569e~tplv-k3u1fbpfcp-zoom-1.image)

### æ€»ç»“ ğŸ¥‡

**çº¸ä¸Šå¾—æ¥ç»ˆè§‰æµ…ï¼Œç»çŸ¥æ­¤äº‹è¦èº¬è¡Œ**ï¼Œå¸Œæœ›å¤§å®¶å¯ä»¥æŠŠç†è®ºé…åˆä¸Šé¢çš„å®ä¾‹è¿›è¡Œæ¶ˆåŒ–ï¼Œæ­å¥½æœåŠ¡ç«¯ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨[æµ‹è¯•å·¥å…·](http://www.easyswoole.com/wstool.html)å¥½å¥½ç©è€ä¸€æ³¢

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b05457faf0ba45f38fbc876f4bbc8585~tplv-k3u1fbpfcp-zoom-1.image)

### å‚è€ƒæ–‡ç«  ğŸ“œ

â¤ï¸ [é˜®ä¸€å³°-WebSocket æ•™ç¨‹](http://www.ruanyifeng.com/blog/2017/05/websocket.html)

â¤ï¸ [Using WebSockets on Heroku with Node.js](https://devcenter.heroku.com/articles/node-websockets)

â¤ï¸ [WebSocket æ˜¯ä»€ä¹ˆåŸç†ï¼Ÿä¸ºä»€ä¹ˆå¯ä»¥å®ç°æŒä¹…è¿æ¥ï¼Ÿ](https://www.zhihu.com/question/20215561/answer/40316953)

### æ‰©å±• ğŸ†

å¦‚æœä½ è§‰å¾—æœ¬æ–‡å¯¹ä½ æœ‰å¸®åŠ©ï¼Œå¯ä»¥æŸ¥çœ‹æˆ‘çš„å…¶ä»–æ–‡ç« â¤ï¸ï¼š

ğŸ‘ [Webå¼€å‘åº”äº†è§£çš„5ç§è®¾è®¡æ¨¡å¼ğŸŠ](https://juejin.im/post/6859506910652006414)

ğŸ‘ [10ä¸ªç®€å•çš„æŠ€å·§è®©ä½ çš„ vue.js ä»£ç æ›´ä¼˜é›…ğŸŠ](https://juejin.im/post/6854573215969181703)

ğŸ‘ [Webå¼€å‘åº”è¯¥çŸ¥é“çš„æ•°æ®ç»“æ„ğŸŠ](https://juejin.im/post/6866970001409064967)

ğŸ‘ [ç»å…¸é¢è¯•é¢˜ï¼ä»è¾“å…¥URLåˆ°é¡µé¢å±•ç¤ºä½ è¿˜ä¸èµ¶ç´§å­¦èµ·æ¥ï¼ŸğŸŠ](https://juejin.im/post/6858551640220729351)

ğŸ‘ [æµ…è°ˆSSLåè®®çš„æ¡æ‰‹è¿‡ç¨‹ğŸŠ](https://juejin.im/post/6856595606677716999)



## äºŒ å‰è¨€

> [è¿”å›ç›®å½•](#chapter-one)

`WebSocket` æ˜¯ `HTML5` æ–°å¢çš„ä¸€ç§å…¨åŒå·¥é€šä¿¡åè®®ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨åŸºäº TCP æ¡æ‰‹è¿æ¥æˆåŠŸåï¼Œä¸¤è€…ä¹‹é—´å°±å¯ä»¥å»ºç«‹æŒä¹…æ€§çš„è¿æ¥ï¼Œå®ç°åŒå‘æ•°æ®ä¼ è¾“ã€‚

## ä¸‰ WebSocket å’Œ HTTP

> [è¿”å›ç›®å½•](#chapter-one)

æˆ‘ä»¬çŸ¥é“ `HTTP` åè®®æ˜¯ä¸€ç§å•å‘çš„ç½‘ç»œåè®®ï¼Œåœ¨å»ºç«‹è¿æ¥åï¼Œå®ƒå…è®¸å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€è¯·æ±‚èµ„æºåï¼ŒæœåŠ¡å™¨æ‰ä¼šè¿”å›ç›¸åº”çš„æ•°æ®ï¼Œè€ŒæœåŠ¡å™¨ä¸èƒ½ä¸»åŠ¨æ¨é€æ•°æ®ç»™å®¢æˆ·ç«¯ã€‚

å½“æ—¶ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡å‘¢ï¼Ÿå‡è®¾ä¸€äº›ä¸è‰¯å¹¿å‘Šå•†ä¸»åŠ¨å°†ä¸€äº›ä¿¡æ¯å¼ºè¡Œæ¨é€ç»™å®¢æˆ·ç«¯ï¼Œè¿™ä¸å¾—ä¸è¯´æ˜¯ä¸€ä¸ªç¾éš¾ã€‚

æ‰€ä»¥ç°åœ¨æˆ‘ä»¬è¦åšè‚¡ç¥¨çš„å®æ—¶è¡Œæƒ…ï¼Œæˆ–è€…è·å–ç«è½¦ç¥¨çš„å‰©ä½™ç¥¨æ•°ç­‰ï¼Œå°±éœ€è¦å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´åå¤åœ°è¿›è¡Œ `HTTP` é€šè®¯ï¼Œå®¢æˆ·ç«¯ä¸æ–­åœ°å‘é€ `GET` è¯·æ±‚ï¼Œå»è·å–å½“å‰çš„å®æ—¶æ•°æ®ã€‚

ä¸‹é¢ä»‹ç»å‡ ç§å¸¸è§çš„æ–¹å¼ã€‚

### 3.1 ï¼ˆçŸ­ï¼‰è½®è¯¢ï¼ˆPollingï¼‰

> [è¿”å›ç›®å½•](#chapter-one)

çŸ­è½®è¯¢æ¨¡å¼ä¸‹ï¼Œå®¢æˆ·ç«¯æ¯éš”ä¸€æ®µæ—¶é—´å‘æœåŠ¡å™¨å‘é€ `HTTP` è¯·æ±‚ã€‚

æœåŠ¡å™¨æ”¶åˆ°è¯·æ±‚åï¼Œå°†æœ€æ–°çš„æ•°æ®å‘å›ç»™å®¢æˆ·ç«¯ã€‚

è¿™ç§æƒ…å†µä¸‹çš„å¼Šç«¯æ˜¯éå¸¸æ˜æ˜¾çš„ï¼šæŸä¸ªæ—¶é—´æ®µæœåŠ¡å™¨æ²¡æœ‰æ›´æ–°å†…å®¹ï¼Œä½†æ˜¯å®¢æˆ·ç«¯æ¯éš”ä¸€æ®µæ—¶é—´å‘é€è¯·æ±‚æ¥è¯¢é—®ï¼Œè€Œè¿™æ®µæ—¶é—´å†…çš„è¯·æ±‚æ˜¯æ— æ•ˆçš„ã€‚

è¿™å°±å¯¼è‡´äº†ç½‘ç»œå¸¦å®½çš„æµªè´¹ã€‚

### 3.2 é•¿è½®è¯¢

> [è¿”å›ç›®å½•](#chapter-one)

é•¿è½®è¯¢æ¨¡å¼ä¸‹ï¼Œå®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘å‡ºè¯·æ±‚ï¼ŒæœåŠ¡å™¨å¹¶ä¸ä¸€å®šä¼šç«‹å³å›åº”å®¢æˆ·ç«¯ï¼Œè€Œæ˜¯æŸ¥çœ‹æ•°æ®æ˜¯å¦æœ‰æ›´æ–°ã€‚

å¦‚æœæ•°æ®æ›´æ–°äº†çš„è¯ï¼Œé‚£å°±ç«‹å³å‘é€æ•°æ®ç»™å®¢æˆ·ç«¯ï¼›å¦‚æœæ²¡æœ‰æ›´æ–°ï¼Œé‚£å°±ä¿æŒè¿™ä¸ªè¯·æ±‚ï¼Œç­‰å¾…æœ‰æ–°çš„æ•°æ®åˆ°æ¥ï¼Œæ‰å°†æ•°æ®è¿”å›ç»™å®¢æˆ·ç«¯ã€‚

å¦‚æœæœåŠ¡å™¨é•¿æ—¶é—´æ²¡æœ‰æ›´æ–°ï¼Œé‚£ä¹ˆä¸€æ®µæ—¶é—´åï¼Œè¯·æ±‚å˜ä¼šè¶…æ—¶ï¼Œå®¢æˆ·ç«¯æ”¶åˆ°æ¶ˆæ¯åï¼Œä¼šç«‹å³å‘é€ä¸€ä¸ªæ–°çš„è¯·æ±‚ç»™æœåŠ¡å™¨ã€‚

å½“ç„¶è¿™ç§æ–¹å¼ä¹Ÿæœ‰å¼Šç«¯ï¼šå½“æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å‘é€æ•°æ®åï¼Œå¿…é¡»ç­‰å¾…ä¸‹ä¸€æ¬¡è¯·æ±‚æ‰èƒ½å°†æ–°çš„æ•°æ®å‘å‡ºï¼Œè¿™æ ·å®¢æˆ·ç«¯æ¥æ”¶æ–°æ•°æ®å°±æœ‰ä¸€ä¸ªæœ€çŸ­æ—¶é—´é—´éš”ã€‚

å¦‚æœæœåŠ¡å™¨æ›´æ–°é¢‘ç‡è¾ƒå¿«ï¼Œé‚£ä¹ˆå°±ä¼šå‡ºç°é—®é¢˜ã€‚

### 3.3 WebSocket

> [è¿”å›ç›®å½•](#chapter-one)

åŸºäºå‰é¢çš„æƒ…å†µï¼Œä¸ºäº†å½»åº•è§£å†³æœåŠ¡å™¨ä¸»åŠ¨å‘å®¢æˆ·ç«¯å‘é€æ•°æ®çš„é—®é¢˜ã€‚

`W3C` åœ¨ `HTML5` ä¸­æä¾›äº†ä¸€ç§è®©å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´è¿›è¡Œå…¨åŒå·¥é€šè®¯çš„ç½‘ç»œæŠ€æœ¯ `WebSocket`ã€‚

`WebSocket` åŸºäº `TCP` åè®®ï¼Œæ˜¯ä¸€ç§å…¨æ–°çš„ã€ç‹¬ç«‹çš„åè®®ï¼Œä¸ `HTTP` åè®®å…¼å®¹å´ä¸ä¼šèå…¥ `HTTP` åè®®ï¼Œä»…ä»…ä½œä¸º `HTML5` çš„ä¸€éƒ¨åˆ†ã€‚

### 3.4 ä¸¤è€…æ¯”å¯¹

> [è¿”å›ç›®å½•](#chapter-one)

åŸºäºä¸Šé¢ï¼Œå°ä¼™ä¼´ä»¬å¤§æ¦‚äº†è§£äº† `WebSocket` çš„ç¼˜ç”±äº†ï¼Œè¿™é‡Œå†æ€»ç»“å¯¹æ¯”ä¸€ä¸‹ `HTTP` å’Œ `WebSocket`ã€‚

- ç›¸åŒç‚¹

1. éƒ½éœ€è¦å»ºç«‹ `TCP` è¿æ¥
2. éƒ½å±äºä¸ƒå±‚åè®®ä¸­çš„åº”ç”¨å±‚åè®®

- ä¸åŒç‚¹

1. `HTTP` æ˜¯å•å‘æ•°æ®æµï¼Œå®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼ŒæœåŠ¡å™¨å“åº”å¹¶è¿”å›æ•°æ®ï¼›`WebSocket` è¿æ¥åå¯ä»¥å®ç°å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨åŒå‘æ•°æ®ä¼ é€’ï¼Œé™¤éæŸä¸€ç«¯æ–­å¼€è¿æ¥ã€‚
2. `HTTP` çš„ `url` ä½¿ç”¨ `http//` æˆ–è€… `https//` å¼€å¤´ï¼Œè€Œ `WebSocket` çš„ `url` ä½¿ç”¨ `ws//` å¼€å¤´

## å›› Socket.io

> [è¿”å›ç›®å½•](#chapter-one)

æˆ‘ä»¬å…ˆæ¥çœ‹ `WebSocket` çš„ä¸€ä¸ªä½¿ç”¨æ–¹å¼ï¼š

```js
const ws = new WebSocket("ws//:xxx.xx", [protocol])

ws.onopen = () => {
  ws.send('hello')
  console.log('send')
}

ws.onmessage = (ev) =>{
  console.log(ev.data)
  ws.close()
}

ws.onclose = (ev) =>{
  console.log('close')
}

ws.onerror = (ev) =>{
  console.log('error')
}
å¤åˆ¶ä»£ç 
```

`WebSocket` å®ä¾‹åŒ–åï¼Œå‰ç«¯å¯ä»¥é€šè¿‡ä¸Šé¢ä»‹ç»çš„æ–¹æ³•è¿›è¡Œå¯¹åº”çš„æ“ä½œï¼Œçœ‹èµ·æ¥è¿˜æ˜¯è›®ç®€å•çš„ã€‚

ä½†æ˜¯ï¼Œå¦‚æœæƒ³å®Œå…¨æ­å»ºä¸€ä¸ª `WebSocket` æœåŠ¡ç«¯æ¯”è¾ƒéº»çƒ¦ï¼Œåˆæµªè´¹æ—¶é—´ã€‚

æ‰€ä»¥ï¼š`Socket.io` åŸºäº `WebSocket`ï¼ŒåŠ ä¸Šè½®è¯¢æœºåˆ¶ä»¥åŠå…¶ä»–çš„å®æ—¶é€šè®¯æ–¹é¢çš„å†…å®¹ï¼Œå®ç°çš„ä¸€ä¸ªåº“ï¼Œå®ƒåœ¨æœåŠ¡ç«¯å®ç°äº†å®æ—¶æœºåˆ¶çš„å“åº”ä»£ç ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œ`WebSocket` ä»…ä»…æ˜¯ `Socket.io` å®ç°é€šè®¯çš„ä¸€ä¸ªå­é›†ã€‚

å› æ­¤ï¼Œ`WebSocket` å®¢æˆ·ç«¯è¿æ¥ä¸ä¸Š `Socket.io` æœåŠ¡ç«¯ï¼Œ`Socket.io` å®¢æˆ·ç«¯ä¹Ÿè¿ä¸ä¸Š `WebSocket` æœåŠ¡ç«¯ã€‚

ä¸‹é¢æˆ‘ä»¬è®²è§£ä¸‹å¦‚ä½•å®ç°ä¸€ä¸ªç®€å•çš„èŠå¤©ã€‚

### 4.1 æœåŠ¡ç«¯ä»£ç 

> [è¿”å›ç›®å½•](#chapter-one)

> package.json

```json
{
  "devDependencies": {
    "express": "^4.15.2",
    "socket.io": "^2.3.0"
  }
}

å¤åˆ¶ä»£ç 
```

> index.js

```js
let express = require('express');
let app = express();
let server = require('http').createServer(app);
let io = require('socket.io')(server);
let path = require('path');

app.use('/', (req, res, next) => {
  res.status(200).sendFile(path.resolve(__dirname, 'index.html'));
});

// å¼€å¯ socket.io
io.on('connection', (client) => {

  // å¦‚æœæœ‰æ–°å®¢æˆ·ç«¯è¿›æ¥ï¼Œæ˜¾ç¤º ID
  console.log(`å®¢æˆ·ç«¯ IDï¼š${client.id}`);

  // ç›‘å¬å®¢æˆ·ç«¯çš„è¾“å…¥ä¿¡æ¯
  client.on('channel', (data) => {
    console.log(`å®¢æˆ·ç«¯ ${client.id} å‘é€ä¿¡æ¯ ${data}`);
    io.emit('broadcast', data);
  });

  // åˆ¤æ–­å®¢æˆ·ç«¯æ˜¯å¦å…³é—­
  client.on('disconnect', () => {
    console.log(`å®¢æˆ·ç«¯å…³é—­ï¼š${client.id}`);
  });
});

server.listen(3000, () => {
  console.log('æœåŠ¡ç›‘å¬ 3000 ç«¯å£');
});
å¤åˆ¶ä»£ç 
```

å¦‚ä¸Šï¼Œæˆ‘ä»¬ç›´æ¥é€šè¿‡ `npm i` å®‰è£…ä¾èµ–åŒ…åï¼Œç›´æ¥é€šè¿‡ `node index.js` å¯ä»¥å¼€å¯æœåŠ¡ã€‚

å½“ç„¶ï¼Œå¦‚æœå°ä¼™ä¼´ä»¬æƒ³æ‰‹åŠ¨è£…åŒ…ï¼Œæ‰§è¡Œä¸‹é¢å‘½ä»¤å³å¯ï¼š

```shell
npm i express socket.io express -D
å¤åˆ¶ä»£ç 
```

### 4.2 å®¢æˆ·ç«¯ä»£ç 

> [è¿”å›ç›®å½•](#chapter-one)

```html
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Socket.io</title>
  <script src="https://cdn.bootcss.com/socket.io/2.2.0/socket.io.slim.js"></script>
</head>

<body>

  <input type="text" id="input">
  <button id="btn">send</button>
  <div id="content-wrap"></div>

  <script>
    window.onload = function () {
      let inputValue = null;

      // è¿æ¥ socket.io
      let socket = io('http://localhost:3000');
      // å°†åˆ›å»ºçš„ä¿¡æ¯ä»¥æ·»åŠ  p æ ‡ç­¾çš„å½¢å¼å±•ç¤ºæˆåˆ—è¡¨
      socket.on('broadcast', data => {
        let content = document.createElement('p');
        content.innerHTML = data;
        document.querySelector('#content-wrap').appendChild(content);
      })

      // è®¾ç½®è¾“å…¥æ¡†çš„å†…å®¹
      let inputChangeHandle = (ev) => {
        inputValue = ev.target.value;
      }
      // è·å–è¾“å…¥æ¡†å¹¶ç›‘å¬è¾“å…¥
      let inputDom = document.querySelector("#input");
      inputDom.addEventListener('input', inputChangeHandle, false);

      // å½“ç”¨æˆ·ç‚¹å‡»å‘é€ä¿¡æ¯çš„æ—¶å€™ï¼Œè¿›è¡Œæ•°æ®äº¤äº’
      let sendHandle = () => {
        socket.emit('channel', inputValue);
      }
      let btnDom = document.querySelector("#btn");
      btnDom.addEventListener('click', sendHandle, false);

      // æ‰“é¡µé¢å¸è½½çš„æ—¶å€™ï¼Œé€šçŸ¥æœåŠ¡å™¨å…³é—­
      window.onunload = () => {
        btnDom.removeEventListener('click', sendHandle, false);
        inputDom.removeEventListener('input', inputChangeHandle, false);
      }
    };
  </script>
</body>

</html>
å¤åˆ¶ä»£ç 
```

### 4.3 å°ç»“

> [è¿”å›ç›®å½•](#chapter-one)

`Socket.io` ä¸ä»…æ”¯æŒ `WebSocket`ï¼Œè¿˜æ”¯æŒè®¸å¤šç§è½®è¯¢æœºåˆ¶ä»¥åŠå…¶ä»–å®æ—¶é€šä¿¡æ–¹å¼ï¼Œå¹¶å°è£…äº†é€šç”¨çš„æ¥å£ã€‚

è¿™äº›æ–¹å¼åŒ…å« `Adobe Flash Socket`ã€`Ajax` é•¿è½®è¯¢ã€`Ajax multipart streaming`ã€æŒä¹… `Iframe`ã€`JSONP` è½®è¯¢ç­‰ã€‚

æ¢å¥è¯è¯´ï¼Œå½“ `Socket.io` æ£€æµ‹åˆ°å½“å‰ç¯å¢ƒä¸æ”¯æŒ `WebSocket` æ—¶ï¼Œèƒ½å¤Ÿè‡ªåŠ¨åœ°é€‰æ‹©æœ€ä½³çš„æ–¹å¼æ¥å®ç°ç½‘ç»œçš„å®æ—¶é€šä¿¡ã€‚

è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯¹ `WebSocket` æœ‰ä¸€å®šçš„äº†è§£ï¼Œé¢è¯•çš„æ—¶å€™å°±ä¸æ…Œäº†ã€‚

## äº” å‚è€ƒæ–‡çŒ®

> [è¿”å›ç›®å½•](#chapter-one)

-  [websocket ä¸Socket.IOä»‹ç»](https://www.cnblogs.com/mazg/p/5467960.html)ã€é˜…è¯»å»ºè®®ï¼š10minã€‘
-  [WebSocket ä¸ Socket.IO](https://zhuanlan.zhihu.com/p/23467317)ã€é˜…è¯»å»ºè®®ï¼š10minã€‘
-  [Websocketå’ŒSocket.ioçš„åŒºåˆ«åŠåº”ç”¨](https://www.jianshu.com/p/970dcfd174dc)ã€é˜…è¯»å»ºè®®ï¼š20minã€‘


ä½œè€…ï¼šjsliang
é“¾æ¥ï¼šhttps://juejin.cn/post/6900433558054109198
æ¥æºï¼šæ˜é‡‘
è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚

# socket.io åŸç†è¯¦è§£

> åœ¨[ä¸Šä¸€ç¯‡æ–‡ç« ä¸­](https://juejin.im/post/6844903768044077069)ï¼Œæˆ‘ä»¬äº†è§£åˆ° `socket.io` æ˜¯ åŸºäº`engine.io` è¿›è¡Œå°è£…çš„åº“ã€‚ æ‰€ä»¥å¯¹`engine.io`ä¸æ¸…æ¥šçš„ç«¥é‹å¯ä»¥ç‚¹å‡»è¿›è¡Œäº†è§£: [engine.io è¯¦è§£](https://juejin.im/post/6844903768044077069)

## 1.æ¦‚è¿°

------

`socket.io` æ˜¯åŸºäº [Websocket](https://html.spec.whatwg.org/multipage/web-sockets.html#the-websocket-interface) çš„Client-Server å®æ—¶é€šä¿¡åº“ã€‚ `socket.io` åº•å±‚ä½¿ç”¨`engine.io` å°è£…äº†ä¸€å±‚åè®®ã€‚

ä¸¤è€…çš„ä¾èµ–å…³ç³»å¯å‚è€ƒ: [package.json](https://github.com/socketio/socket.io-client/blob/master/package.json)

## 2. WebSocket ç®€ä»‹

------

`Websocket å®šä¹‰` [å‚è€ƒè§„èŒƒ rfc6455](https://tools.ietf.org/html/rfc6455)

**è§„èŒƒè§£é‡Š** `Websocket` æ˜¯ä¸€ç§æä¾›å®¢æˆ·ç«¯(æä¾›ä¸å¯é ç§˜é’¥)ä¸æœåŠ¡ç«¯(æ ¡éªŒé€šè¿‡è¯¥ç§˜é’¥)è¿›è¡Œ**åŒå‘é€šä¿¡**çš„åè®®ã€‚

åœ¨æ²¡æœ‰`websocket`åè®®ä¹‹å‰ï¼Œè¦æä¾›å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯å®æ—¶**åŒå‘æ¨é€**æ¶ˆæ¯ï¼Œå°±ä¼šä½¿ç”¨`polling`æŠ€æœ¯ï¼Œå®¢æˆ·ç«¯é€šè¿‡`xhr`æˆ–`jsonp` **å‘é€**æ¶ˆæ¯ç»™æœåŠ¡ç«¯ï¼Œå¹¶é€šè¿‡äº‹ä»¶å›è°ƒæ¥**æ¥æ”¶**æœåŠ¡ç«¯æ¶ˆæ¯ã€‚

è¿™ç§æŠ€æœ¯è™½ç„¶ä¹Ÿèƒ½ä¿è¯åŒå‘é€šä¿¡ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªä¸å¯é¿å…çš„é—®é¢˜ï¼Œå°±æ˜¯**æ€§èƒ½é—®é¢˜**ã€‚å®¢æˆ·ç«¯ä¸æ–­å‘æœåŠ¡ç«¯å‘é€è¯·æ±‚ï¼Œå¦‚æœå®¢æˆ·ç«¯å¹¶å‘æ•°è¿‡å¤§ï¼Œæ— ç–‘å¯¼è‡´æœåŠ¡ç«¯å‹åŠ›å‰§å¢ã€‚å› æ­¤ï¼Œ`websocket`å°±æ˜¯è§£å†³è¿™ä¸€ç—›ç‚¹è€Œè¯ç”Ÿçš„ã€‚

è¿™é‡Œå†å»¶ä¼¸ä¸€äº›åè¯:

- **é•¿è½®è¯¢** å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘é€`xhr`è¯·æ±‚,æœåŠ¡ç«¯æ¥æ”¶å¹¶`hold`è¯¥è¯·æ±‚ï¼Œç›´åˆ°æœ‰æ–°æ¶ˆæ¯`push`åˆ°å®¢æˆ·ç«¯ï¼Œæ‰ä¼šä¸»åŠ¨æ–­å¼€è¯¥è¿æ¥ã€‚ç„¶åï¼Œå®¢æˆ·ç«¯å¤„ç†è¯¥`response`åå†å‘æœåŠ¡ç«¯å‘èµ·æ–°çš„è¯·æ±‚ã€‚ä»¥æ­¤ç±»æ¨ã€‚

> ```
> HTTP1.1`é»˜è®¤ä½¿ç”¨é•¿è¿æ¥ï¼Œä½¿ç”¨é•¿è¿æ¥çš„`HTTP`åè®®ï¼Œä¼šåœ¨å“åº”å¤´ä¸­åŠ å…¥ä¸‹é¢è¿™è¡Œä¿¡æ¯: `Connection:keep-alive
> ```

- **çŸ­è½®è¯¢**:

å®¢æˆ·ç«¯ä¸ç®¡æ˜¯å¦æ”¶åˆ°æœåŠ¡ç«¯çš„`response`æ•°æ®ï¼Œéƒ½ä¼šå®šæ—¶æƒ³æœåŠ¡ç«¯å‘é€è¯·æ±‚ï¼ŒæŸ¥è¯¢æ˜¯å¦æœ‰æ•°æ®æ›´æ–°ã€‚

- **é•¿è¿æ¥** æŒ‡åœ¨ä¸€ä¸ª`TCP`è¿æ¥ä¸Šå¯ä»¥å‘é€å¤šä¸ªæ•°æ®åŒ…ï¼Œåœ¨`TCP`è¿æ¥ä¿æŒæœŸé—´ï¼Œå¦‚æœæ²¡æœ‰æ•°æ®åŒ…å‘é€ï¼Œåˆ™åŒæ–¹å°±éœ€è¦å‘é€`å¿ƒè·³åŒ…`æ¥ç»´æŒæ­¤è¿æ¥ã€‚

> è¿æ¥è¿‡ç¨‹: å»ºç«‹è¿æ¥â€”â€”æ•°æ®ä¼ è¾“â€”â€”...â€”â€”(å‘é€å¿ƒè·³åŒ…ï¼Œç»´æŒè¿æ¥)â€”â€”...â€”â€”æ•°æ®ä¼ è¾“â€”â€”å…³é—­è¿æ¥

- **çŸ­è¿æ¥** æŒ‡é€šä¿¡åŒæ–¹æœ‰æ•°æ®äº¤äº’æ—¶ï¼Œå»ºç«‹ä¸€ä¸ª`TCP`è¿æ¥ï¼Œæ•°æ®å‘é€å®Œæˆä¹‹åï¼Œåˆ™æ–­å¼€æ­¤è¿æ¥ã€‚

> è¿æ¥è¿‡ç¨‹: å»ºç«‹è¿æ¥â€”â€”æ•°æ®ä¼ è¾“â€”â€”æ–­å¼€è¿æ¥â€”â€”...â€”â€”å»ºç«‹è¿æ¥â€”â€”æ•°æ®ä¼ è¾“â€”â€”æ–­å¼€è¿æ¥

**Tips**

> è¿™é‡Œæœ‰ä¸€ä¸ª**è¯¯è§£**ï¼Œé•¿è¿æ¥å’ŒçŸ­è¿æ¥çš„æ¦‚å¿µæœ¬è´¨ä¸ŠæŒ‡çš„æ˜¯ä¼ è¾“å±‚çš„`TCP`è¿æ¥ï¼Œå› ä¸º`HTTP1.1`åè®®ä»¥åï¼Œè¿æ¥é»˜è®¤éƒ½æ˜¯é•¿è¿æ¥ã€‚æ²¡æœ‰çŸ­è¿æ¥è¯´æ³•(`HTTP1.0`é»˜è®¤ä½¿ç”¨çŸ­è¿æ¥)ï¼Œç½‘ä¸Šå¤§å¤šæ•°æŒ‡çš„é•¿çŸ­è¿æ¥å®è´¨ä¸Šè¯´çš„å°±æ˜¯`TCP`è¿æ¥ã€‚ `http`ä½¿ç”¨é•¿è¿æ¥çš„å¥½å¤„: å½“æˆ‘ä»¬è¯·æ±‚ä¸€ä¸ªç½‘é¡µèµ„æºçš„æ—¶å€™ï¼Œä¼šå¸¦æœ‰å¾ˆå¤š`js`ã€`css`ç­‰èµ„æºæ–‡ä»¶ï¼Œå¦‚æœä½¿ç”¨çš„æ—¶çŸ­è¿æ¥çš„è¯ï¼Œå°±ä¼šæ‰“å¼€å¾ˆå¤š`tcp`è¿æ¥ï¼Œå¦‚æœå®¢æˆ·ç«¯è¯·æ±‚æ•°è¿‡å¤§ï¼Œå¯¼è‡´`tcp`è¿æ¥æ•°é‡è¿‡å¤šï¼Œå¯¹æœåŠ¡ç«¯é€ æˆå‹åŠ›ä¹Ÿå°±å¯æƒ³è€ŒçŸ¥äº†ã€‚

- **å•å·¥** æ•°æ®ä¼ è¾“çš„æ–¹å‘å”¯ä¸€ï¼Œåªèƒ½ç”±å‘é€æ–¹å‘æ¥æ”¶æ–¹çš„å•ä¸€å›ºå®šæ–¹å‘ä¼ è¾“æ•°æ®ã€‚
- **åŠåŒå·¥** å³é€šä¿¡åŒæ–¹æ—¢æ˜¯æ¥æ”¶æ–¹ä¹Ÿæ˜¯å‘é€æ–¹ï¼Œä¸è¿‡ï¼Œåœ¨æŸä¸€æ—¶åˆ»åªèƒ½å…è®¸å‘ä¸€ä¸ªæ–¹å‘ä¼ è¾“æ•°æ®ã€‚
- **å…¨åŒå·¥**: å³é€šä¿¡åŒæ–¹æ—¢æ˜¯æ¥æ”¶æ–¹ä¹Ÿæ˜¯å‘é€æ–¹ï¼Œä¸¤ç«¯è®¾å¤‡å¯ä»¥åŒæ—¶å‘é€å’Œæ¥æ”¶æ•°æ®ã€‚

**Tips**

> **å•å·¥**ã€**åŠåŒå·¥**å’Œ**å…¨åŒå·¥** è¿™ä¸‰è€…éƒ½æ˜¯å»ºç«‹åœ¨ `TCP`åè®®(ä¼ è¾“å±‚ä¸Š)çš„æ¦‚å¿µï¼Œä¸è¦ä¸åº”ç”¨å±‚è¿›è¡Œæ··æ·†ã€‚

## 3. ä»€ä¹ˆæ˜¯Websocket

------

`Websocket` åè®®ä¹Ÿæ˜¯åŸºäº`TCP`åè®®çš„ï¼Œæ˜¯ä¸€ç§åŒå…¨å·¥é€šä¿¡æŠ€æœ¯ã€å¤ç”¨`HTTP`æ¡æ‰‹é€šé“ã€‚

`Websocket`é»˜è®¤ä½¿ç”¨è¯·æ±‚åè®®ä¸º:`ws://`,é»˜è®¤ç«¯å£:`80`ã€‚å¯¹`TLS`åŠ å¯†è¯·æ±‚åè®®ä¸º:`wss://`ï¼Œç«¯å£:`443`ã€‚

### 3.1 ç‰¹ç‚¹

- **æ”¯æŒæµè§ˆå™¨/Nodejsç¯å¢ƒ**
- **æ”¯æŒåŒå‘é€šä¿¡**
- **APIç®€å•æ˜“ç”¨**
- **æ”¯æŒäºŒè¿›åˆ¶ä¼ è¾“**
- **å‡å°‘ä¼ è¾“æ•°æ®é‡**

### 3.2 å»ºç«‹è¿æ¥è¿‡ç¨‹

`Websocket`å¤ç”¨äº†`HTTP`çš„æ¡æ‰‹é€šé“ã€‚æŒ‡çš„æ˜¯ï¼Œå®¢æˆ·ç«¯å‘é€`HTTP`è¯·æ±‚ï¼Œå¹¶åœ¨è¯·æ±‚å¤´ä¸­å¸¦ä¸Š`Connection: Upgrade` ã€`Upgrade: websocket`ï¼ŒæœåŠ¡ç«¯è¯†åˆ«è¯¥headerä¹‹åï¼Œè¿›è¡Œåè®®å‡çº§ï¼Œä½¿ç”¨`Websocket`åè®®è¿›è¡Œæ•°æ®é€šä¿¡ã€‚



![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://user-gold-cdn.xitu.io/2019/4/6/169f1656159c8519?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)



**å‚æ•°è¯´æ˜**

- `Request URL` è¯·æ±‚æœåŠ¡ç«¯åœ°å€
- `Request Method` è¯·æ±‚æ–¹å¼ (æ”¯æŒget/post/option)
- `Status Code` 101 Switching Protocols

[RFC 7231 è§„èŒƒå®šä¹‰](https://tools.ietf.org/html/rfc7231#section-6.2.2)

> è§„èŒƒè§£é‡Š: å½“æ”¶åˆ°101è¯·æ±‚çŠ¶æ€ç æ—¶ï¼Œè¡¨æ˜æœåŠ¡ç«¯ç†è§£å¹¶åŒæ„å®¢æˆ·ç«¯è¯·æ±‚ï¼Œæ›´æ”¹`Upgrade` headerå­—æ®µã€‚æœåŠ¡ç«¯ä¹Ÿå¿…é¡»åœ¨`response`ä¸­ï¼Œç”Ÿæˆå¯¹åº”çš„`Upgrade`å€¼ã€‚

- `Connection` è®¾ç½®`upgrade` header,é€šçŸ¥æœåŠ¡ç«¯ï¼Œè¯¥`request`ç±»å‹éœ€è¦è¿›è¡Œå‡çº§ä¸º`websocket`ã€‚ [upgrade_mechanism è§„èŒƒ](https://developer.mozilla.org/en-US/docs/Web/HTTP/Protocol_upgrade_mechanism)
- `Host` æœåŠ¡ç«¯ hostname
- `Origin` å®¢æˆ·ç«¯ hostname:port
- `Sec-WebSocket-Extensions` å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘èµ·è¯·æ±‚æ‰©å±•åˆ—è¡¨(list)ï¼Œä¾›æœåŠ¡ç«¯é€‰æ‹©å¹¶åœ¨å“åº”ä¸­è¿”å›
- `Sec-WebSocket-Key` ç§˜é’¥çš„å€¼æ˜¯é€šè¿‡è§„èŒƒä¸­å®šä¹‰çš„ç®—æ³•è¿›è¡Œè®¡ç®—å¾—å‡ºï¼Œå› æ­¤æ˜¯ä¸å®‰å…¨çš„ï¼Œä½†æ˜¯å¯ä»¥é˜»æ­¢ä¸€äº›è¯¯æ“ä½œçš„websocketè¯·æ±‚ã€‚
- `Sec-WebSocket-Accept` è®¡ç®—å…¬å¼: 1. è·å–å®¢æˆ·ç«¯è¯·æ±‚headerçš„å€¼: `Sec-WebSocket-Key` 2. ä½¿ç”¨é­”æ•°magic = '258EAFA5-E914-47DA-95CA-C5AB0DC85B11' 3. é€šè¿‡`SHA1`è¿›è¡ŒåŠ å¯†è®¡ç®—, sha1(Sec-WebSocket-Key + magic) 4. å°†å€¼è½¬æ¢ä¸ºbase64
- `Sec-WebSocket-Protocol` æŒ‡å®šæœ‰é™ä½¿ç”¨çš„Websocketåè®®ï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªåè®®åˆ—è¡¨(list)ã€‚æœåŠ¡ç«¯åœ¨`response`ä¸­è¿”å›åˆ—è¡¨ä¸­æ”¯æŒçš„ç¬¬ä¸€ä¸ªå€¼ã€‚
- `Sec-WebSocket-Version` æŒ‡å®šé€šä¿¡æ—¶ä½¿ç”¨çš„Websocketåè®®ç‰ˆæœ¬ã€‚æœ€æ–°ç‰ˆæœ¬:13,[å†å²ç‰ˆæœ¬](https://www.iana.org/assignments/websocket/websocket.xml#version-number)
- `Upgrade` é€šçŸ¥æœåŠ¡ç«¯ï¼ŒæŒ‡å®šå‡çº§åè®®ç±»å‹ä¸º`websocket`

### 3.3 æ•°æ®å¸§æ ¼å¼

æ•°æ®æ ¼å¼å®šä¹‰å‚è€ƒï¼š[è§„èŒƒ RFC6455](https://tools.ietf.org/html/rfc6455#section-5.2)

```
  0                   1                   2                   3
  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-------+-+-------------+-------------------------------+
 |F|R|R|R| opcode|M| Payload len |    Extended payload length    |
 |I|S|S|S|  (4)  |A|     (7)     |             (16/64)           |
 |N|V|V|V|       |S|             |   (if payload len==126/127)   |
 | |1|2|3|       |K|             |                               |
 +-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +
 |     Extended payload length continued, if payload len == 127  |
 + - - - - - - - - - - - - - - - +-------------------------------+
 |                               |Masking-key, if MASK set to 1  |
 +-------------------------------+-------------------------------+
 | Masking-key (continued)       |          Payload Data         |
 +-------------------------------- - - - - - - - - - - - - - - - +
 :                     Payload Data continued ...                :
 + - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +
 |                     Payload Data continued ...                |
 +---------------------------------------------------------------+
å¤åˆ¶ä»£ç 
```

- `FIN`: 1 bit å¦‚æœè¯¥ä½å€¼ä¸º1ï¼Œè¡¨ç¤ºè¿™æ˜¯`message`çš„æœ€ç»ˆç‰‡æ®µ(`fragment`)ï¼Œå¦‚æœä¸º0ï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ª`message`çš„ç¬¬ä¸€ä¸ªç‰‡æ®µã€‚
- `RSV1, RSV2, RSV3`: å„å 1 bit ä¸€èˆ¬é»˜è®¤å€¼æ˜¯0ï¼Œé™¤éåå•†æ‰©å±•ï¼Œä¸ºéé›¶å€¼è¿›è¡Œå®šä¹‰ï¼Œå¦åˆ™æ”¶åˆ°éé›¶å€¼ï¼Œå¹¶ä¸”æ²¡æœ‰è¿›è¡Œåå•†æ‰©å±•å®šä¹‰ï¼Œåˆ™`websocket`è¿æ¥å¤±è´¥ã€‚
- `Opcode`: 4 bits æ ¹æ®æ“ä½œç (`Opcode`),è§£ææœ‰æ•ˆè½½è·æ•°æ®(`Payload data`).å¦‚æœæ¥å—åˆ°æœªå®šä¹‰æ“ä½œç ï¼Œåˆ™åº”è¯¥æ–­å¼€`websocket`è¿æ¥ã€‚
- `Mask`: 1 bit å®šä¹‰æ˜¯å¦éœ€è¦çš„è½½è·æ•°æ®(``Payload data)ï¼Œè¿›è¡Œæ©ç æ“ä½œã€‚å¦‚æœè®¾ç½®å€¼ä¸º1ï¼Œé‚£ä¹ˆåœ¨`Masking-key`ä¸­ä¼šå®šä¹‰ä¸€ä¸ªæ©ç key,å¹¶ç”¨è¿™ä¸ªkeyå¯¹è½½è·æ•°æ®è¿›è¡Œåæ©ç (`unmask`)æ“ä½œã€‚æ‰€æœ‰ä»å®¢æˆ·ç«¯å‘é€åˆ°æœåŠ¡ç«¯çš„æ•°æ®å¸§(`frame`),maskéƒ½è¢«è®¾ç½®ä¸º1.
- `Payload length`: 7 bits, 7+16 bits, or 7+64 bits è½½è·æ•°æ®çš„é•¿åº¦ã€‚
- `Masking-key`: 0 or 4 bytes æ‰€æœ‰ä»å®¢æˆ·ç«¯ä¼ é€åˆ°æœåŠ¡ç«¯çš„æ•°æ®å¸§ï¼Œæ•°æ®è½½è·éƒ½è¿›è¡Œäº†æ©ç æ“ä½œï¼ŒMaskä¸º1ï¼Œä¸”æºå¸¦äº†4å­—èŠ‚çš„Masking-keyã€‚å¦‚æœMaskä¸º0ï¼Œåˆ™æ²¡æœ‰Masking-keyã€‚
- `Payload data`: (x+y) bytes

### 3.4 å¿ƒè·³æ£€æµ‹

ä¸ºäº†ç¡®ä¿å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„é•¿è¿æ¥æ­£å¸¸ï¼Œæœ‰æ—¶å³ä½¿å®¢æˆ·ç«¯è¿æ¥ä¸­æ–­ï¼Œä½†æ˜¯æœåŠ¡ç«¯æœªè§¦å‘`onclose`äº‹ä»¶ï¼Œè¿™å°±æœ‰å¯èƒ½å¯¼è‡´æ— æ•ˆè¿æ¥å ç”¨ã€‚æ‰€ä»¥éœ€è¦ä¸€ç§æœºåˆ¶ï¼Œç¡®ä¿ä¸¤ç«¯çš„è¿æ¥å¤„äºæ­£å¸¸çŠ¶æ€ï¼Œ**å¿ƒè·³æ£€æµ‹**å°±æ˜¯è¿™ç§æœºåˆ¶ã€‚å®¢æˆ·ç«¯æ¯éš”ä¸€æ®µæ—¶é—´ï¼Œä¼šå‘æœåŠ¡ç«¯å‘é€**å¿ƒè·³**(æ•°æ®åŒ…)ï¼ŒæœåŠ¡ç«¯ä¹Ÿä¼šè¿”å›`response`è¿›è¡Œåé¦ˆè¿æ¥æ­£å¸¸ã€‚

## 4. socket.io ç®€ä»‹

------

`socket.io`ä¸`engine.io`çš„ä¸€å¤§åŒºåˆ«åœ¨äºï¼Œ`socket.io`å¹¶ä¸ç›´æ¥æä¾›è¿æ¥åŠŸèƒ½ï¼Œè€Œæ˜¯åœ¨`engine.io`å±‚æä¾›ã€‚

`socket.io`æä¾›äº†ä¸€ä¸ª**æˆ¿é—´**(`Namespace`)æ¦‚å¿µã€‚å½“å®¢æˆ·ç«¯åˆ›å»ºä¸€ä¸ªæ–°çš„é•¿è¿æ¥æ—¶ï¼Œå°±ä¼šåˆ†é…ä¸€ä¸ªæ–°çš„`Namespace`è¿›è¡ŒåŒºåˆ†ã€‚



![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://user-gold-cdn.xitu.io/2019/1/26/1688a7bbbe59d2b5?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)



æ ¹æ®æµç¨‹å›¾ï¼Œå¯ä»¥çœ‹å‡º:

- åˆ›å»ºé•¿è¿æ¥çš„æ–¹å¼æœ‰ä¸‰ç§: `websocket`ã€`xhr`ã€`jsonp`ã€‚å…¶ä¸­ï¼Œåä¸¤ç§ä½¿ç”¨é•¿è½®è¯¢çš„æ–¹å¼è¿›è¡Œæ¨¡æ‹Ÿã€‚
- æ‰€è°“çš„é•¿è½®è¯¢æ˜¯æŒ‡ï¼Œå®¢æˆ·ç«¯å‘é€ä¸€æ¬¡`request`ï¼Œå½“æœåŠ¡ç«¯æœ‰æ¶ˆæ¯æ¨é€æ—¶ä¼špushä¸€æ¡`response`ç»™å®¢æˆ·ç«¯ã€‚å®¢æˆ·ç«¯æ”¶åˆ°`response`åï¼Œä¼šå†æ¬¡å‘é€`request`ï¼Œé‡å¤ä¸Šè¿°è¿‡ç¨‹ï¼Œç›´åˆ°å…¶ä¸­ä¸€ç«¯ä¸»åŠ¨æ–­å¼€è¿æ¥ä¸ºæ­¢ã€‚

```
// lookup æºç 
var parsed = url(uri)
var source = parsed.source
var id = parsed.id
var path = parsed.path
// æŸ¥æ‰¾ç›¸åŒæˆ¿é—´
var sameNamespace = cache[id] && path in cache[id].nsps
// å¦‚æœæˆ¿é—´å·å·²å­˜åœ¨ï¼Œåˆ›å»ºæ–°è¿æ¥
var newConnection = sameNamespace
// ...
å¤åˆ¶ä»£ç 
```

`socket.io`ä¹Ÿæä¾›æ”¯æŒå¤šè·¯å¤ç”¨(`built-in multiplexing`)æ–¹å¼ï¼Œè¿™è¡¨æ˜æ¯ä¸€ä¸ªæ•°æ®åŒ…(`Packet`)éƒ½å§‹ç»ˆå±äºç»™å®šçš„`namespace`ï¼Œå¹¶æœ‰`path`è¿›è¡Œæ ‡è¯†(ä¾‹å¦‚: `/xxxx`)

`socket.io`å¯ä»¥åœ¨ `open` ä¹‹å‰ï¼Œ`emit` æ¶ˆæ¯ï¼Œå¹¶ä¸”è¯¥æ¶ˆæ¯ä¼šåœ¨ `open` ä¹‹åå‘å‡ºã€‚è€Œ`engine.io`å¿…é¡»ç­‰åˆ°`open` ä¹‹åï¼Œæ‰èƒ½ `send`æ¶ˆæ¯ã€‚

`socket.io`ä¹Ÿæ”¯æŒæ–­ç½‘é‡è¿(`reconnection`)åŠŸèƒ½ã€‚

## 5. socket.io å·¥ä½œæµç¨‹

> å½“ä½¿ç”¨`socket.io`åˆ›å»ºä¸€ä¸ªé•¿è¿æ¥æ—¶ï¼Œåˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆå‘¢?ä¸‹é¢æˆ‘ä»¬å°±æ¥è¿›å…¥æœ¬æ–‡çš„æ­£ä½“:

```
const socket = io('http://localhost', {
  path: '/myownpath'
});
å¤åˆ¶ä»£ç 
```

é¦–å…ˆï¼Œ`socket.io`é€šè¿‡ä¸€ä¸ª`http`è¯·æ±‚,å¹¶ä¸”è¯¥è¯·æ±‚å¤´ä¸­å¸¦æœ‰å‡çº§åè®®(`Connection:Upgrade`ã€`Upgrade:websocket`)ç­‰ä¿¡æ¯ï¼Œå‘Šè¯‰æœåŠ¡ç«¯å‡†å¤‡å»ºç«‹è¿æ¥ï¼Œæ­¤æ—¶ï¼Œåç«¯è¿”å›çš„`response`æ•°æ®ã€‚ **æ•°æ®æ ¼å¼å¦‚ä¸‹**:

```
0{"sid":"ab4507c4-d947-4deb-92e4-8a9e34a9f0b2","upgrades":["websocket"],"pingInterval":25000,"pingTimeout":60000}
å¤åˆ¶ä»£ç 
```

- **0**: ä»£è¡¨`open`æ ‡è¯†
- **sid**: session id
- **upgrades**: å‡çº§åè®®ç±»å‹
- **pingInterval**ï¼š `ping`çš„é—´éš”æ—¶é•¿
- **pingTimeout**ï¼š åˆ¤æ–­è¿æ¥è¶…æ—¶æ—¶é•¿

å½“å®¢æˆ·ç«¯æ”¶åˆ°å“åº”ä¹‹åï¼Œ`scoket.io`ä¼šæ ¹æ®å½“å‰å®¢æˆ·ç«¯ç¯å¢ƒæ˜¯å¦æ”¯æŒ`Websocket`ã€‚å¦‚æœæ”¯æŒï¼Œåˆ™å»ºç«‹ä¸€ä¸ª`websocket`è¿æ¥ï¼Œå¦åˆ™ä½¿ç”¨`polling`(`xhr`ã€`jsonp`)é•¿è½®è¯¢è¿›è¡Œ**åŒå‘æ•°æ®é€šä¿¡**ã€‚

## 6. socket.io åè®®è§£æ

`socket.io`åè®®ä¸­å®šä¹‰çš„æ•°æ®æ ¼å¼ç§°ä¹‹ä¸º`Pakcet` ï¼Œæ¯ä¸€ä¸ª`Packet`éƒ½å«æœ‰`nsp`çš„å¯¹è±¡å€¼ã€‚



![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://user-gold-cdn.xitu.io/2019/4/6/169f165615aad5bc?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)



**Packet**

ç¼–ç åŒ…å¯ä»¥æ˜¯**UTF8**æˆ–**äºŒè¿›åˆ¶**æ•°æ®ï¼Œç¼–ç æ ¼å¼å¦‚ä¸‹:

> <**åŒ…ç±»å‹id**>[<**data**>]

ä¾‹å¦‚:

> 2probe

åŒ…ç±»å‹id(packet type id)æ˜¯ä¸€ä¸ªæ•´å‹ï¼Œå…·ä½“å«ä¹‰å¦‚ä¸‹:

- **0 open** å½“æ‰“å¼€ä¸€ä¸ªæ–°ä¼ è¾“æ—¶ï¼ŒæœåŠ¡ç«¯æ£€æµ‹å¹¶å‘é€
- **1 close** è¯·æ±‚å…³é—­ä¼ è¾“ï¼Œä½†ä¸æ˜¯ä¸»åŠ¨æ–­å¼€è¿æ¥
- **2 ping** å®¢æˆ·ç«¯å‘å‡ºï¼ŒæœåŠ¡ç«¯åº”è¯¥è¿”å›åŒ…å«ç›¸åŒæ•°æ®çš„`pong` packetè¿›è¡Œåº”ç­”
- **3 pong** æœåŠ¡ç«¯å‘å‡ºï¼Œç”¨ä»¥å“åº”å®¢æˆ·ç«¯çš„`ping` packet
- **4 message** çœŸå®æ•°æ®ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯åº”è¯¥è°ƒç”¨å›è°ƒä¸­çš„`data`

```
// æœåŠ¡ç«¯å‘é€ 
send('4HelloWorld')
// å®¢æˆ·ç«¯æ¥æ”¶æ•°æ®å¹¶è°ƒç”¨å›è°ƒ 
socket.on('message', function (data) { console.log(data); });
// å®¢æˆ·ç«¯å‘é€ 
send('4HelloWorld')
// æœåŠ¡ç«¯æ¥æ”¶æ•°æ®å¹¶è°ƒç”¨å›è°ƒ 
socket.on('message', function (data) { console.log(data); })
å¤åˆ¶ä»£ç 
```

- **5 upgrade** åœ¨`engine.io`åˆ‡æ¢ä¼ è¾“ä¹‹å‰ï¼Œå®ƒä¼šæµ‹è¯•æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯æ˜¯å¦å¯ä»¥é€šè¿‡æ­¤ä¼ è¾“è¿›è¡Œé€šä¿¡ã€‚å¦‚æœæ­¤æµ‹è¯•æˆåŠŸï¼Œå®¢æˆ·ç«¯å°†å‘é€å‡çº§æ•°æ®åŒ…ï¼Œè¯·æ±‚æœåŠ¡å™¨åˆ·æ–°æ—§ä¼ è¾“ä¸Šçš„ç¼“å­˜å¹¶åˆ‡æ¢åˆ°æ–°ä¼ è¾“ã€‚

- 6 noop

   

  ```
  noop
  ```

   

  packetã€‚ä¸»è¦ç”¨äºåœ¨æ”¶åˆ°ä¼ å…¥çš„

  ```
  websocket
  ```

  è¿æ¥æ—¶å¼ºåˆ¶è½®è¯¢å‘¨æœŸã€‚

  1. å®¢æˆ·ç«¯é€šè¿‡æ–°çš„ä¼ è¾“è¿æ¥
  2. å®¢æˆ·ç«¯å‘é€ `2send`
  3. æœåŠ¡ç«¯æ¥æ”¶å¹¶å‘é€ `3probe`
  4. å®¢æˆ·ç«¯ç»“æŸå¹¶å‘é€ `5`
  5. æœåŠ¡ç«¯åˆ·æ–°å¹¶å…³é—­æ—§çš„ä¼ è¾“è¿æ¥å¹¶åˆ‡æ¢åˆ°æ–°ä¼ è¾“è¿æ¥

## 7. socket.io å…¨å®¶æ¡¶

------



![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://user-gold-cdn.xitu.io/2019/4/6/169f165615fbc8e8?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)



**åŒºåˆ«**

- [engine.io-parser](https://github.com/socketio/engine.io-parser) `engine.io`åè®®ç¼–ç çš„jsè§£æå™¨ã€‚[engine.io åè®®è§„èŒƒ](https://github.com/socketio/engine.io-protocol)
- [socket.io](https://github.com/socketio/socket.io)
- [socket.io-client](https://github.com/socketio/socket.io-client)
- [socket.io-parser](https://github.com/socketio/socket.io-parser)
- [socket.io-adapter](https://github.com/socketio/socket.io-adapter)
- [socket.io-redis](https://github.com/socketio/socket.io-redis)
- [engine.io](https://github.com/socketio/engine.io)
- [engine.io-client](https://github.com/socketio/engine.io-client)