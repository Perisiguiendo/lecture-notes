# 前端必需了解的CDN知识

> CDN的全称是Content Delivery Network，即内容分发网络。由于CDN是为加快网络访问速度而被优化的网络覆盖层，因此被形象地称为“网络加速器”。

CDN可以加快用户访问网络资源的速度和稳定性，减轻源服务器的访问压力。

## 一、CDN简介

**主要思路：** 尽可能避开互联网上有可能影响数据传输速度和稳定性的瓶颈和环节，使内容传输的更快、更稳定。

**实现方法：** 通过在网络各处放置**节点服务器**所构成的在现有的互联网基础之上的一层**智能虚拟网络**，CDN系统能够实时地根据网络流量和各节点的**连接和负载**状况以及到用户的**距离**和**响应时间**等综合信息将用户的请求重新**导向离用户最近的服务节点**上，加快访问速度。

**目的：** 使用户可`就近`取得所需内容，解决Internet网络拥挤的状况，提高用户访问网站的`响应速度`。

**优势：**

1. CDN节点解决了跨运营商和跨地域访问的问题，访问延时大大降低；
2. 大部分请求在CDN边缘节点完成，CDN起到了分流作用，减轻了源站的负载。

## 二、CDN基本工作流程

首先是**不使用CDN**的情况下的流程：

1. 用户在自己的浏览器中输入要访问的网站域名。
2. 浏览器向 本地DNS服务器 请求对该域名的解析。
3. 本地DNS服务器中如果缓存有这个域名的解析结果，则直接响应用户的解析请求。
4. 本地DNS服务器中如果没有关于这个域名的解析结果的缓存，则以递归方式向整个DNS系统请求解析，获得应答后将结果反馈给浏览器。
5. 浏览器得到域名解析结果，就是该域名相应的服务设备的 IP地址 。
6. 浏览器向服务器请求内容。
7. 服务器将用户请求内容传送给浏览器。

当**使用了CDN**时，DNS 服务器根据用户 IP 地址，将域名解析成相应节点的缓存服务器IP地址，实现用户就近访问。使用 CDN 服务的网站，只需将其域名解析权交给 CDN 的全局负载均衡（GSLB）设备，将需要分发的内容注入 CDN，就可以实现内容加速了。

1. 当用户点击网站页面上的内容URL，经过**本地**DNS系统解析，DNS 系统会最终将域名的解析权交给 `CNAME` 指向的 CDN 专用 DNS 服务器。
2. CDN 的 DNS 服务器将 CDN 的**全局负载均衡设备** `IP` 地址返回用户。
3. 用户向 CDN 的全局负载均衡设备发起内容 URL 访问请求。
4. CDN 全局负载均衡设备根据用户 IP 地址，以及用户请求的内容URL，选择一台用户所属区域的区域负载均衡设备，告诉用户向这台设备发起请求。
5. 基于以下这些条件的综合分析之后，区域负载均衡设备会向全局负载均衡设备返回一台缓存服务器的IP地址：
   - 根据用户 IP 地址，判断哪一台服务器距用户最近；
   - 根据用户所请求的 URL 中携带的内容名称，判断哪一台服务器上有用户所需内容；
   - 查询各个服务器当前的负载情况，判断哪一台服务器尚有服务能力。
6. 全局负载均衡设备把服务器的 IP 地址返回给用户。
7. 用户向缓存服务器发起请求，缓存服务器响应用户请求，将用户所需内容传送到用户终端。如果这台缓存服务器上并没有用户想要的内容，而区域均衡设备依然将它分配给了用户，那么这台服务器就要向它的上一级缓存服务器请求内容，直至追溯到网站的源服务器将内容拉到本地。

## 三、CDN的作用

CDN最常用的功能当然是`加速`，但还有一些其他功能。

### 1. 加速访问

CDN可以使用户就近获取所需内容，降低网络拥塞，提高用户访问响应速度和命中率。

还提供服务器端加速，解决由于用户访问量大造成的服务器过载问题；

### 2. 实现跨运营商、跨地域的全网覆盖

互联不互通、区域ISP地域局限、出口带宽受限制等种种因素都造成了网站的区域性无法访问。

CDN加速可以覆盖全球的线路，通过和运营商合作，部署IDC资源，在全国骨干节点商，合理部署CDN边缘分发存储节点，充分利用带宽资源，平衡源站流量。

### 3. 保障你的网站安全

CDN的负载均衡和分布式存储技术，可以加强网站的可靠性，相当无无形中给你的网站添加了一把保护伞，应对绝大部分的互联网攻击事件。防攻击系统也能避免网站遭到恶意攻击。

### 4. 异地备援

当某个服务器发生意外故障时，系统将会调用其他临近的健康服务器节点进行服务，进而提供接近100%的可靠性，这就让你的网站可以做到永不宕机。

### 5. 节约成本

能克服**网站分布不均**的问题，投入使用CDN加速可以实现网站的全国铺设，你根据不用考虑购买服务器与后续的托管运维，服务器之间镜像同步，也不用为了管理维护技术人员而烦恼，并且能降低网站自身建设和维护成本。

### 6. 让你更专注业务本身

CDN加速厂商一般都会提供一站式服务，业务不仅限于CDN，还有配套的云存储、大数据服务、视频云服务等，而且一般会提供7x24运维监控支持，保证网络随时畅通，你可以放心使用。并且将更多的精力投入到发展自身的核心业务之上。

## 四、CDN工作原理

CDN的基本原理是广泛采用各种缓存服务器，将这些缓存服务器分布到用户访问相对集中的地区或网络中，在用户访问网站时，利用全局负载技术将用户的访问指向距离最近的工作正常的缓存服务器上，由缓存服务器直接响应用户请求。

### 1. 用户访问cdn资源的过程

1. 用户向浏览器输入www.web.com这个域名，浏览器第一次发现本地没有DNS缓存，则向网站的DNS服务器请求；
2. 网站的DNS域名解析器设置了CNAME，指向了www.web.51cdn.com,请求指向了CDN网络中的智能DNS负载均衡系统；
3. 智能DNS负载均衡系统解析域名，把对用户响应速度最快的IP节点（CDN服务器）返回给用户；
4. 用户向该IP节点（CDN服务器）发出请求；
5. 由于是第一次访问，CDN服务器会向原web站点请求，并缓存内容；
6. 请求结果发给用户。

### 2. cdn主要特点

1. **本地Cache加速** 提高了企业站点（尤其含有大量图片和静态页面站点）的访问速度，并大大提高以上性质站点的稳定性
2. **镜像服务** 消除了不同运营商之间互联的瓶颈造成的影响，实现了跨运营商的网络加速，保证不同网络中的用户都能得到良好的访问质量。
3. **远程加速** 远程访问用户根据DNS负载均衡技术智能自动选择Cache服务器，选择最快的Cache服务器，加快远程访问的速度
4. **带宽优化** 自动生成服务器的远程Mirror（镜像）cache服务器，远程用户访问时从cache服务器上读取数据，减少远程访问的带宽、分担网络流量、减轻原站点WEB服务器负载等功能。
5. **集群抗攻击** 广泛分布的CDN节点加上节点之间的智能冗余机制，可以有效地预防黑客入侵以及降低各种D.D.o.S攻击对网站的影响，同时保证较好的服务质量 。

## 五、CDN对网络的优化：

1. 解决服务器端的“第一公里”问题
2. 缓解甚至消除了不同运营商之间互联的瓶颈造成的影响
3. 减轻了各省的出口带宽压力
4. 缓解了骨干网的压力
5. 优化了网上热点内容的分布

**第一公里** 是指万维网流量向用户传送的第一个出口，是网站服务器接入互联网的链路所能提供的带宽。 这个带宽决定了一个 网站能为用户提供的访问速度和并发访问量。如果业务繁忙，用户的访问数越多，拥塞越严重，网站会在最需要向用户提供服务时失去用户。

**中间一公里** 代表互联网中节点与节点之间的传输网络。

**最后一公里** 万维网流量向用户传送的最后一段接入链路。

## 六、CDN的应用场景

### 1. 网站站点/应用加速

站点或者应用中大量静态资源的加速分发，建议将站点内容进行动静分离，动态文件可以结合云服务器ECS，静态资源如各类型图片、html、css、js文件等，建议结合 对象存储OSS 存储海量静态资源，可以有效加速内容加载速度，轻松搞定网站图片、短视频等内容分发

### 2. 视音频点播/大文件下载分发加速

支持各类文件的下载、分发，支持在线点播加速业务，如mp4、flv视频文件或者平均单个文件大小在20M以上，主要的业务场景是视音频点播、大文件下载（如安装包下载）等，建议搭配对象存储OSS使用，可提升回源速度，节约近2/3回源带宽成本。

### 3. 视频直播加速（内测中）

视频流媒体直播服务，支持媒资存储、切片转码、访问鉴权、内容分发加速一体化解决方案。结合弹性伸缩服务，及时调整服务器带宽，应对突发访问流量；结合媒体转码服务，享受高速稳定的并行转码，且任务规模无缝扩展。目前CDN直播加速已服务内部用户测试并优化，即将上线

### 4. 移动应用加速

移动APP更新文件（apk文件）分发，移动APP内图片、页面、短视频、UGC等内容的优化加速分发。提供httpDNS服务，避免DNS劫持并获得实时精确的DNS解析结果，有效缩短用户访问时间，提升用户体验。

## 七、CDN缓存

缓存是`空间换时间`的思路，通过使用多余的空间，换来更快的访问速度。

- 不使用cdn缓存时

所有的用户都直接访问源服务器

![img](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/97533f31385343498f3857eab1d01b3a~tplv-k3u1fbpfcp-watermark.image)

- 使用cdn缓存时

客户端浏览器先检查是否有本地缓存是否过期，如果过期，则向CDN边缘节点发起请求，CDN边缘节点会检测用户请求数据的缓存是否过期，如果cdn数据没有过期，则直接响应用户请求，此时一个完成http请求结束；如果cdn数据已经过期，那么CDN还需要向源站发出回源请求，来拉取最新的数据。

![img](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/526d6452f50147a98f0d29275c5fc78f~tplv-k3u1fbpfcp-watermark.image)

**缓存优点：** CDN的分流作用不仅减少了用户的访问延时，也减少的源站的负载。

**缺点：** 当网站更新时，如果CDN节点上数据没有及时更新，即便用户再浏览器使用Ctrl+F5的方式使浏览器端的缓存失效，也会因为CDN边缘节点没有同步最新数据而导致用户访问异常。

### 八、解决CDN缓存更新的办法

1. 资源url参数加时间戳

url的参数加上时间戳，每次更新时时间戳也跟随更新，重新使cdn边缘节点同步源服务器最新数据。

```sh
http://www.cdn.com/static/images/test.png # 没加时间戳
http://www.cdn.com/static/images/test.png?_t=202012290910 # 加了时间戳
复制代码
```

1. 调用cdn服务商提供的**刷新缓存**接口

CDN边缘节点对开发者是透明的，相比于浏览器Ctrl+F5的强制刷新来使浏览器本地缓存失效，开发者可以通过CDN服务商提供的“刷新缓存”接口来达到清理CDN边缘节点缓存的目的。

这样开发者在更新数据后，可以使用“刷新缓存”功能来强制CDN节点上的数据缓存过期，保证客户端在访问时，拉取到最新的数据。

## 七、cdn的组成

### 1. 部署架构

CDN 系统设计的首要目标是尽量**减少用户的访问响应时间**，为达到这一目标，CDN 系统应该尽量将用户所需要的内容**存放在距离用户最近的位置**。也就是说，负责为用户提供内容服务的 Cache 设备应部署在物理上的网络边缘位置，我们称这一层为`CDN边缘层`。CDN 系统中负责全局性管理和控制的设备组成`中心层`，中心层同时保存着最多的内容副本，当边缘层设备未命中时，会向中心层请求，如果在中心层仍未命中，则需要中心层向源站回源。

不同CDN系统设计之间存在差异，中心层可能具备用户服务能力，也可能不直接提供服务，只向下级节点提供内容。如果CDN网络规模较大，边缘层设备直接向中心层请求内容或服务会造成中心层设备压力过大，就要考虑在边缘层和中心层之间部署一个`区域层`，负责一个区域的管理和控制，也保存部分内容副本供边缘层访问。

如图是一个典型的CDN系统三级部署示意图:

![img](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6db24ee3dcb84eed84b7736b09bdaec9~tplv-k3u1fbpfcp-watermark.image)

### 2. 设备组成

CDN网络中包含的功能实体主要由以下几个部分组成：

- 内容缓存设备
- 内容交换机
- 内容路由器
- CDN内容管理系统

### 1. 内容缓存设备

内容缓存为**CDN网络节**点，位于用户接入点，是面向最终用户的内容提供设备，可缓存静态Web内容和流媒体内容，实现内容的边缘传播和存储，以便用户的就近访问。

### 2. 内容交换机

内容交换机处于**用户接入集中点**，可以均衡单点多个内容缓存设备的负载，并对内容进行缓存负载平衡及访问控制。

### 3. 内容路由器

内容路由器负责将用户的请求**调度到适当的设备**上。

内容路由通常通过负载均衡系统来实现，动态均衡各个内容缓存站点的载荷分配，为用户的请求选择最佳的访问站点，同时提高网站的可用性。

内容路由器可根据多种因素制定路由，包括站点与用户的临近度、内容的可用性、网络负载、设备状况等。

**负载均衡系统是整个CDN的核心。负载均衡的准确性和效率直接决定了整个CDN的效率和性能。**

### 4. 内容管理系统

内容管理系统负责整个CDN的**管理**，是**可选部件**，作用是进行内容管理，如内容的注入和发布、内容的分发、内容的审核、内容的服务等。

## 参考

- [CDN概念基本介绍 - 全能程序猿 - 简书](https://www.jianshu.com/p/a64675c6b73b)
- [CDN原理简单介绍 - 奇哥 - 知乎](https://zhuanlan.zhihu.com/p/113037678)
- [CDN - 百度百科](https://baike.baidu.com/item/CDN)
- [也许是史上最全的一次CDN详解 - 视界云首席客服 - 知乎](https://zhuanlan.zhihu.com/p/28940451)
- [CDN详解](https://segmentfault.com/a/1190000010631404)

## **CDN 的优点**

## **访问加速**

CDN 作为前端性能经典手段，相信大家已经无脑使用了，正如前面所说的，减少了时延，从很大程度上就能作为加速手段了。实际上，真正的 CDN 并不是前面举例的一个国家一个节点，甚至是一个运营商，一个省份乃至地区都会有节点。

![img](https://pic1.zhimg.com/80/v2-b34f3e8432f795de43ac67cd3a75ce28_720w.jpg)

￼

## **减轻源站（服务器）负载**

一个非常简单就能想明白的问题，如果 CDN 已经能帮我返回数据了，那么请求就不会到达源站，源站（服务器）的负载就减轻了。

## **抗住攻击**

既然源站的负载被减轻了，那么在受到 DDOS 攻击的时候，也能谈笑风生。

![img](https://pic4.zhimg.com/80/v2-be6756e45fc9ad99b264bea3e5dd7c87_720w.jpg)

当年阮老师被 DDOS 闹的满城风雨，后来阮老师就把内容开始迁移到 GayHub……

然后本来我不用更新内容，就在最近，阮老师发布了一篇 DDOS 防御指南，然后接着被攻击，又瘫痪了，防御指南中说自己受到了 CC，然后迁移到了腾讯云，啪啪啪打了我的脸……当然，其实 CC 并没有那么难防御，但是不在分享主题内容中，感兴趣的可以之后聊……

受到阮老师启发，于是我糊了一个架构图，一个博客系统的思路图，基本上和市面上的 Jekyll 和 Hexo 一样，当时我的设想是，把评论之类的全部抽出来，这样打的时候最多打挂评论之类的，对于博文本身不会有任何影响。后来我回去查了一下，发现这不就和市面上的一样嘛——不错！

![img](https://pic1.zhimg.com/80/v2-cef0740f644fadf9a67d2b1a146183a8_720w.jpg)



那么既然静态资源能上 CDN，我们的 API，我们的 MVC 页面能不能也上 CDN？答案是可以的，关键就是这个叫[全站加速](https://link.zhihu.com/?target=https%3A//help.aliyun.com/document_detail/64808.html%3Fspm%3Da2c4g.11174283.6.577.sJwsYO)的东西。

啥玩样儿？其实 CDN 就是一个缓存，区别只是这个缓存是放在网络服务提供商节点的。

最简单的模型像这张图，这张图来自《大型网站技术架构 核心原理与案例分析》一书。



![img](https://pic2.zhimg.com/80/v2-979f3193cb1ce313391c866f118f64dd_720w.jpg)



## **访问原理**

从我们发起请求，到到达 CDN 节点，到底经过了哪些东西，CDN 是怎么加速我们的请求的呢？

![img](https://pic3.zhimg.com/80/v2-d4ab223ee51aaeaa24c85271721de10e_720w.jpg)

￼

这张图也是网上找来的。

首先我们在地址栏键入一个网址，浏览器发现本地没有关于这个网址的 DNS 缓存，所以向网站的 DNS 服务器发起请求。

网站的 DNS 服务器设置了 CNAME，指向了某个 CDN 服务器，也就是我们常见的阿里云、腾讯云、Cloudflare 之类的，去请求 CDN 中的智能 DNS 均衡负载系统。

均衡负载系统解析域名，把对用户响应最快的节点返回给用户，然后用户向该节点发出请求。

如果是第一次访问该内容，CDN 服务器会向源站请求数据并缓存，否则的话，直接在缓存节点中找到该数据，将请求结果发给用户。

对于最简单的 CDN 系统而言，只要一台 DNS 调度服务器和一个节点服务器即可，但在复杂的应用中，会存在多级缓存，多台 Cache 来协同工作。

这里我之前在博客里写过[类似的内容](https://link.zhihu.com/?target=https%3A//codesky.me/archives/what-is-cdn.wind)（实际上就是摘抄的）

## **架设原理**

如果你要架设一个 CDN，大概需要怎么做？记住我们刚才介绍的内容，重点是，CDN 仍然是一个缓存。



![img](https://pic2.zhimg.com/80/v2-dac0ceee1be5d19f40b70e15d0300235_720w.jpg)

￼

拿来阿里云 CDN 的架构图口胡一下，我也没有搭建过，如果解释的不对请大家指出。

既然是缓存，那么很明显，也就是均衡负载加上缓存调度的搭配，根据我们刚才所说的访问原理，其实主要的重点除了均衡负载与缓存外，就是一个中央的 DNS 调度器。

实际上，和计算机的多级缓存设计以及后端的多级缓存设计一样，每一层的 cache 一级比一级大，可以存储更多资源，但是响应一个比一个耗时，如果在 L1 中无法命中，那么我们就会去 L2 找，L2 无法命中才会回到源站，这样可以有效的避免回到源站过于频繁的问题。

![img](https://pic1.zhimg.com/80/v2-bdf7d26016d8f30cdb3a948b0d820890_720w.jpg)

￼

接下来这张图，我就有点编不下去了，在阿里，主要使用 LVS + Tengine 做负载均衡，然后用 Swift 做 HTTP 缓存。这是他们自己说的，但是和我没什么关系，我主要讲的是左边那个花括号的一致性 Hash。

一致性 Hash 就是把对象映射在 232 个桶空间里，像一个闭合的圆环，当然，实际上，我们将机器也映射到这个圆环中，比如利用别名或者 IP，顺时针将对象将内容存储到离自己最近的机器中，删除和添加节点也一样，添加和删除节点之后，根据顺时针迁移，原来的对象会进行重新计算。

关于这点需要详细了解可以看这篇：[https://blog.csdn.net/cywosp/article/details/23397179](https://link.zhihu.com/?target=https%3A//blog.csdn.net/cywosp/article/details/23397179)

![img](https://pic2.zhimg.com/80/v2-9ca3b06c45ceb0ce2abce624b5820fcd_720w.jpg)

￼

然后说完这个关键性算法，我们就差不多消化了——隔壁阿里云 CDN 是怎么搞出来的。

当然这依旧和我们没啥关系……

## **应用与踩坑**

最常见的应用，就是用于前端静态资源的加速，实际上，利用 CDN，我们甚至可以做出一套属于自己的 [jsDelivr](https://link.zhihu.com/?target=https%3A//www.jsdelivr.com/)。

不过，使用 CDN 的时候，有一些基本法需要我们了解。

## **缓存设置**

第一，缓存的设置，max-age 我们都用过，在 Cache-Control 中经常用于缓存的控制，可是 max-age 设置的缓存会应用于一个请求经过的每一级，如果我们希望 CDN 不缓存那么久，要怎么办呢？那就是 s-maxage，它用于设置代理服务器的缓存时间，会覆盖 max-age 的设置，这样我们可以把 max-age 用于本地缓存，把 s-maxage 用于 CDN 缓存时间，避免脏数据的产生。

## **缓存命中率**

对于一个缓存而言，还有一点很重要，就是你的缓存到底有没有用，衡量这个东西的就是缓存命中率。如果只是静态资源，在刷新缓存之后，可能会导致命中率下降，因此 CDN 的资源不适合经常刷新，换句话说，如果一个请求结果会经常进行变更，那么 CDN 基本就没什么存在的意义。

## **判断是否命中缓存**

无论是我们自己在开发过程中，还是帮客户 debug 的过程中，我们都会考虑一件事——这个资源是否命中了CDN，是否是因为CDN导致的问题，这个时候就要秀一波操作了。

![img](https://pic2.zhimg.com/80/v2-fdc8fbb56b81bf28a26bc03f289225a1_720w.jpg)

￼

在各大厂商的 CDN 返回的数据中都会有一个 X-Cache，上面内容是 Hit 或者 Miss，还会加上诸如 Memory 或者 Disk 的缩写表示内存还是磁盘，如果出现 Upstream 或者 Miss 则表示没有命中。

## **资源预热**

缓存设计中，预热是很重要的环节，在最初刚开始启动 CDN 的时候，CDN 上并没有缓存数据，此刻大量的请求全部打向源站，肯定会把源站打挂，预热就是实现缓存好热门数据，这样在业务上线时，CDN 上已经有所需的数据了。

## **Vary**

此外很多 CDN 都不支持 Vary 头，这样 CORS 需要的 Vary: Origin 就没法保证了，遇到这种情况，比如你发现 Origin 头被缓存了，就只能把跨域头改为 * 去匹配。

## **Range**

另外如果是很大的文件，往往是用 RANGE 头分片载入的，但如果 CDN 没有进行分片，就会重复向源站请求完整资源，CDN 就白搞了，启用 RANGE 回源，就可以减少流量的损耗，正确的设置 RANGE 回源，就能够正确的命中 CDN 缓存。

## **无私钥 HTTPS**

另外重点说一下：这年头上 HTTPS 已经是常规基本法了，而不上 HTTPS 才是个喷点，CDN 为了避免篡改和劫持，当然也得上 HTTPS，但这样就导致我们必须要将证书和私钥传输到 CDN 的平台中去，对于安全性是一个隐患。

所以就有了无私钥解决方案，用户搭建私钥服务器，由 CDN 方去请求签名。图为阿里云的实现，只要在自己的服务器上部署 KeyServer 和配置就可以用了。

![img](https://pic1.zhimg.com/80/v2-464b1d7781edb03216f15d9a5ff57c04_720w.jpg)

￼

这里我在上海 FCC 分享的时候有同学想要具体了解一下，具体来说的话涉及到很多 HTTPS 加密的事情，暂时不做展开，可以看一下 CloudFlare 发的一篇文章，我正好找到了翻译版：[https://www.zcfy.cc/article/keyless-ssl-the-nitty-gritty-technical-details-967.html](https://link.zhihu.com/?target=https%3A//www.zcfy.cc/article/keyless-ssl-the-nitty-gritty-technical-details-967.html)

## **现实世界的 CDN**

![img](https://pic3.zhimg.com/80/v2-4df2f339b5182e1a834236ea0fd18e62_720w.jpg)

￼比如，节点挂了，直接导致的是用户的损失，尤其是体量大的公司依赖 CDN 进行静态资源管理的时候，发生这样的事情后果会非常严重。

其次，便宜没好货：本来在只有网宿而没有阿里云的时代，CDN 是很昂贵的，阿里腾讯在拉低 CDN 价格的同时，也拉低了 CDN 的质量，部分节点的访问质量不太高会导致有些用户访问的网络质量非常差。

然后，一个微小的科普：什么是混合 CDN——混合 CDN 这个名词看着很高端，实际上就是，我们用了多家厂商的 CDN，可能也包括自己建的，然后谁好的选谁，但是有的时候反而会造成服务不可控，进一步劣化 CDN 的质量。

## **总结**

CDN 这个东西本质就是一个缓存，只是这个缓存离你特别特别的近，作为用户还是开发都能从中享受到一点福利，但作为一个服务于企业的开发人员，不仅要考虑 CDN 的优点，也要知道 CDN 给我们带来的坑，这样才能靠谱的作为 CDN 的使用者。



## CDN原理

上面介绍的DNS，是在没有引入CDN的情况下的流程，如果使用了CDN，那么流程就会变了。

### CNAME

首先需要了解，CNAME 是什么东西。

#### 1，A记录

即Address记录，它并不是一个IP或者一个域名，我们可以把它理解为一种指向关系：

- 域名 www.xx.com → 111.111.111.111
- 主机名 DD → 222.222.222.222

可以理解为，最终的域名与IP的对应关系这条记录，就是A记录

#### 2，CNAME

为什么要区分A记录和CNAME？我们可以把CNAME记录叫做别名记录，就是小名。

比如A记录为：

www.credit.com  → 111.111.111.111

那么可能有多个CNAME记录

www.100fen.com → www.credit.com

www.baifen.com → www.credit.com

------

所以大概理解了吧，CNAME就是你主域名A记录的小名

CNAME指向A记录，A记录指向具体的IP地址。

一个网址可以有多个CNAME，可以理解为就是域名转发

### CDN流程

CDN的全称是 Content Delivery Network ，即内容分发网络。其目的是通过在现有的Internet流程中增加一层新的网络架构，将网站的内容发布到最接近用户的网络“边缘” ，使用户可以就近取得所需的内容，解决 Internet 网络拥塞状况，提高用户访问网站的响应速度。从技术上全面解决由于网络带宽小、用户访问量大、网点分布不均等原因，解决用户访问网站的响应速度慢的根本原因。

**使用CDN好处？**

- 提升网页加载速度
- 处理高流量负载
- 无需?本完成本地化覆盖
- 减少带宽消耗
- 在多台服务器间均衡负载
- 使你的网站免于DDoS（拒绝服务）的攻击
- ……

#### CDN大体是如何工作的？



![img](https://user-gold-cdn.xitu.io/2020/7/20/1736be1b5d892583?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)





![img](https://user-gold-cdn.xitu.io/2020/7/20/1736be1d180937c8?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)



在之前的DNS解析步骤4中，是向本地域名服务器（可以认为是你的网络接入服务器商提供，比如中国电信，中国移动）中请求

那么引入了CDN后，在这一步中就发生了变化。

我们把本地域名服务器当做阿里云中的域名产品，把 www.credit.com 当做我们从阿里云申请的域名。

如果没有CDN，我们就可以直接配置  www.credit.com → 111.111.111.111，所以一般情况下，DNS步骤解析5的迭代查询，其实是不需要的。

如果我们想引入CDN的话，

在阿里云的控制台，我们可以对 www.credit.com 域名设置几个 CNAME 的配置，比如我们配置：

- CNMAE记录： www.credit.com → cdn.credit.com
- A记录：cdn.credit.com → 222.222.222.222

### CDN 是怎么做到优化的

#### 负载均衡

CDN负载均衡设备会为用户选择一台合适的缓存服务器提供服务。

选择的依据包括：

根据用户IP地址，判断哪一台服务器距离用户最近；

根据用户所请求的URL中携带的内容名称，判断哪一台服务器上有用户所需内容；

查询各个服务器的负载情况，判断哪一台服务器的负载较小。

基于以上这些依据的综合分析之后，负载均衡设置会把缓存服务器的IP地址返回给用户。

#### 缓存

缓存服务器响应用户请求，将用户所需内容传送到用户。

如果这台缓存服务器上并没有用户想要的内容，而负载均衡设备依然将它分配给了用户，那么这台服务器就要向它的上一级缓存服务器请求内容，直至追溯到网站的源服务器将内容拉取到本地。

缓存还涉及到很多算法，比如，用空间换时间的这种高效的数据结构和算法，多级缓存以热度来区分，前端是SSD后面是机械硬盘等等。。。

#### CDN总结

在网站和用户之间引入CDN之后，用户不会有任何与原来不同的感觉。

使用CDN服务的网站，只需将其域名的解析权交给CDN的负载均衡设备，CDN负载均衡设备将为用户选择一台合适的缓存服务器，用户通过访问这台缓存服务器来获取自己所需的数据。

由于缓存服务器部署在网络运营商的机房，而这些运营商又是用户的网络服务提供商，因此用户可以以最短的路径，最快的速度对网站进行访问。因此，CDN可以加速用户访问速度，减少源站中心负载压力。

## DNS和CDN整体流程的总结

比如我们请求 www.credit.com 域名

1，首先，浏览器会从自身的DNS缓存中去查找（chrome://net-internals/#dns），如果没有则进行下一步

2，然后，浏览器会先从操作系统里的DNS缓存中找，windows系统中，命令行 ipconfig/displaydns 查看，linux上的NSCD缓存服务；；；如果没有则进行下一步

3，从计算机host文件里找，这个我们经常配置吧；；；如果没有则进行下一步

4，请求本地域名服务器（可以认为是 阿里云等域名供应商），

发现阿里云里面有进行过配置，CNMAE记录： www.credit.com → cdn.credit.com ，所以此时告诉浏览器转为请求 cdn.credit.com

此时，浏览器转为请求cdn.credit.com ，上面的1-3步还得再来一遍。。。

1-3步骤重复

4，请求本地域名服务器（可以认为是 阿里云等域名供应商），

发现阿里云里面有进行过配置，A记录：cdn.credit.com → 222.222.222.222 ，然后就把 IP 222.222.222.222 返回给浏览器。

5，浏览器得到了IP地址，注意这个IP地址，实际上是CDN负载均衡服务器的地址。。。继续请求这个地址

6，请求进入到了CDN负载均衡服务器后，服务器会根据算法策略等，返回一个最合适的文件缓存服务器IP地址，至于怎么选择合适的，看下面的优化

7，浏览器访问文件缓存服务器IP地址，最后得到文件资源


作者：晴天633
链接：https://juejin.cn/post/6854573212425814030
来源：掘金
著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。